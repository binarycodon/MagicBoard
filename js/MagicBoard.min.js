var inheritsFrom=function(e,t){e.prototype=Object.create(t.prototype)},MagicBoard={sheetBook:null,indicators:{mouseDown:!1,mouseover:[],click:!1,doubleClick:0,resize:-1},boardPos:{x:0,y:0},theme:{sheetBackground:null,shapeColor:"#1b8d11",arrowFillColor:"#1b8d11",borderColor:"white",lineColor:"#1b8d11",textColor:"white",otherSheetVisibility:"hidden"},scratch:{path:[]},changed:!1,counter:0,callbacks:{alert:"alert"}};MagicBoard.properties={"background-color":{propType:"attribute",propName:"fill",label:"Background Color",field:"input",values:[{name:"",value:MagicBoard.theme.shapeColor,type:"color"}]},"border-color":{propName:"stroke",propType:"attribute",label:"Border Color",field:"input",values:[{name:"",value:MagicBoard.theme.shapeColor,type:"color"}]},"border-width":{propName:"stroke-width",propType:"attribute",label:"Border Width",field:"input",values:[{name:"",value:"1",type:"text"}]},"border-style":{propName:"stroke-dasharray",propType:"attribute",label:"Border Style",field:"select",values:[{name:"Dash",value:"5,5",type:""},{name:"Solid",value:"",type:""},{name:"Dotted",value:"1,1",type:""}]},text:{propName:"innerHTML",propType:"dom",label:"Text",field:"input",values:[{name:"",value:"",type:"text"}]},"text-color":{propName:"fill",propType:"attribute",label:"Text Color",field:"input",values:[{name:"",value:"#ffffff",type:"color"}]},"font-size":{propName:"font-size",propType:"attribute",label:"Font Color",field:"input",values:[{name:"",value:"14",type:"text"}]},"font-weight":{propName:"font-weight",propType:"attribute",label:"Font Weight",field:"select",values:[{name:"Regular",value:"regular"},{name:"Bold",value:"bold"},{name:"Italic",value:"italic"}]},"text-content":{propName:"innerHTML",propType:"dom",label:"Text",field:"textarea",values:[{value:""}]},"line-type":{propName:"",propType:"function",field:"select",label:"Line Type",values:[{name:"Straight",value:"straight"},{name:"Zig Zag",value:"zig-zag"},{name:"Brezier Curve",value:"brezier"},{name:"Quadratic Curve",value:"quadratic"}]},"line-color":{propName:"stroke",propType:"attribute",label:"Line Color",field:"input",values:[{name:"",value:MagicBoard.theme.shapeColor,type:"color"}]},"line-width":{propName:"stroke-width",propType:"attribute",label:"Line Width",field:"input",values:[{name:"",value:"1",type:"text"}]},"line-style":{propName:"stroke-dasharray",propType:"attribute",label:"Line Style",field:"select",values:[{name:"Solid",value:"",type:""},{name:"Dash",value:"5,5",type:""},{name:"Dotted",value:"1,1",type:""}]},"end-marker":{propName:"marker-end",propType:"attribute",label:"End Marker",field:"select",values:[{name:"Filled Arrow",value:"url(#fillArrowE)"},{name:"Hollow Arrow",value:"url(#hollowArrowE)"},{name:"Regular Arrow",value:"url(#lineArrowE)"},{name:"Cicle",value:"url(#dot)"},{name:"Hollow Diamond",value:"url(#hollowDiamond)"},{name:"Filled Diamond",value:"url(#fillDiamond)"},{name:"No Arrow",value:""}]},"start-marker":{propName:"marker-start",propType:"attribute",label:"Start Marker",field:"select",values:[{name:"Filled Arrow",value:"url(#fillArrowS)"},{name:"Hollow Arrow",value:"url(#hollowArrowS)"},{name:"Regular Arrow",value:"url(#lineArrowS)"},{name:"Cicle",value:"url(#dot)"},{name:"Hollow Diamond",value:"url(#hollowDiamond)"},{name:"Filled Diamond",value:"url(#fillDiamond)"},{name:"No Arrow",value:""}]},"mid-marker":{propName:"marker-mid",propType:"attribute",field:"select",label:"Mid Marker",values:[{name:"Dot",value:"url(#dot)"}]}};var SheetBook=function(e,t,i){this.cheight=400,this.cwidth=400,this.sheets=[],this.currentSheet=null,this.anchor=document.body,this.zoomPercent=100,this.zoomCompensate=1,this.alignments={x:[],y:[]},this.maxRedo=5,this.garbage=document.createElement("div"),this.garbage.setAttribute("style","display:none"),document.body.appendChild(this.garbage),i&&(this.cheight=i),t&&(this.cwidth=t),e&&(this.anchor=e);var a=e.getBoundingClientRect();MagicBoard.boardPos={x:a.left,y:a.top},Utility.SheetBook.createWorkItems(this),document.onmousedown=function(e){return MagicBoard.eventStart(e)},document.onmousemove=function(e){MagicBoard.eventContinue(e)},document.onmouseup=function(e){MagicBoard.eventStop(e)},document.onkeyup=function(e){event.preventDefault(),MagicBoard.keyUp(e)},document.onscroll=function(){var e=MagicBoard.sheetBook.anchor.getBoundingClientRect();MagicBoard.boardPos={x:e.left,y:e.top}}};SheetBook.prototype.zoom=function(e){this.zoomPercent=e,this.anchor.style.zoom=e/100,this.zoomCompensate=1+(100-e)/100},SheetBook.prototype.setAnchorElement=function(e){this.anchor=e},SheetBook.prototype.addSheet=function(e){this.sheets.push(e);var t=e.getCanvas();t.setAttribute("height",this.cheight),t.setAttribute("width",this.cwidth),t.style.width=this.cwidth+"px",t.style.height=this.cheight+"px",this.anchor.appendChild(t),this.setCurrentSheet(e),MagicBoard.changed=!0},SheetBook.prototype.getSheet=function(e){for(var t=this.sheets.length-1;t>-1;t--){var i=this.sheets[t];if(i.name===e)return i}return null},SheetBook.prototype.getCurrentSheet=function(){return this.currentSheet},SheetBook.prototype.setCurrentSheet=function(e){var t=null,i=!1;"string"==typeof e&&(t=e,i=!0);for(var a=this.sheets.length-1;a>-1;a--){var o=this.sheets[a];o.canvas.style.visibility=MagicBoard.theme.otherSheetVisibility,o.active=!1,i?o.name===t&&(o.active=!0,this.currentSheet=o):o===e&&(e.active=!0,this.currentSheet=e)}e.canvas.style.visibility="visible";var r=this.connectCanvas;MagicBoard.sheetBook.connectCtx.clearRect(0,0,r.width,r.height)},SheetBook.prototype.getCombinedImage=function(){var e=this.scratchCtx;if(e){e.clearRect(0,0,this.cwidth,this.cheight);for(var t=this.shapes.length,i=0;t>i;i++){var a=this.shapes[i];a.draw(e)}var o=this.scratchCanvas.toDataURL();return o}},SheetBook.prototype.setHeight=function(e){this.cheight=e,this.anchor.style.height=e;for(var t=0,i=this.sheets.length;i>t;t++){var a=this.sheets[t],o=a.getCanvas();o.setAttribute("height",this.cheight),o.style.height=this.cheight+"px",setTimeout(function(){Utility.Sheet.createGrid(a)},10)}this.connectCanvas.height=e,this.scratchCanvas.height=e},SheetBook.prototype.setWidth=function(e){this.cwidth=e,this.anchor.style.width=e;for(var t=0,i=this.sheets.length;i>t;t++){var a=this.sheets[t],o=a.getCanvas();o.setAttribute("width",this.cwidth),o.style.width=this.cwidth+"px",setTimeout(function(){Utility.Sheet.createGrid(a)},10)}this.connectCanvas.width=e,this.scratchCanvas.width=e},SheetBook.prototype.save=function(){var e={version:1,sheets:[]};for(s=0,sLen=this.sheets.length;s<sLen;s++)e.sheets.push(this.sheets[s].save());return MagicBoard.changed=!1,e};var Sheet=function(e){this.options={},this.name="Sheet1",e.name&&(this.name=e.name),this.temp=e,this.canvas=null,this.init()};Sheet.prototype.init=function(){this.removedShapes=[],this.active=!0,this.canvas=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.canvas.setAttribute("id",this.name),this.canvas.style.position="absolute",this.canvas.style.left="0px",this.canvas.style.top="0px",this.canvas.style["z-index"]="1",this.canvas.setAttribute("name","mg"),this.canvas.style.visibility="visible";var e=this.options["background-color"];if(e&&(this.canvas.style.fill=e),this.connections=[],Utility.Sheet.Markers(this),Utility.Sheet.createGrid(this),MagicBoard.sheetBook.currentSheet=this,this.shapes=[],this.temp.shapes){for(var t=0,i=this.temp.shapes.length;i>t;t++){var a=null,o=this.temp.shapes[t];if(o.typeId&&"ConnectorLine"===o.typeId){var r=o;r.beginShape=Utility.Sheet.findShapeById(o.beginShapeId),r.endShape=Utility.Sheet.findShapeById(o.endShapeId),this.connections.push(r)}else a=new Shape(o),a.draw(),a.setPosition({x:a.dimension.left,y:a.dimension.top})}delete this.temp}},Sheet.prototype.getCanvas=function(){return this.canvas},Sheet.prototype.rename=function(e){this.name=e,this.options.name=e,MagicBoard.changed=!0},Sheet.prototype["delete"]=function(){this.wipe();for(var e=MagicBoard.sheetBook.sheets,t=e.length-1;t>-1;t--){var i=e[t];if(i===this){e.splice(t,1);break}}var a=this.getCanvas();Utility.destroyDom(a,"dom"),MagicBoard.changed=!0},Sheet.prototype.wipe=function(){for(var e=MagicBoard.sheetBook.garbage,t=this.canvas.children,i=t.length-1;i>-1;i--){var a=t[i];"workItem"!==a.getAttribute("name")&&e.appendChild(a)}e.innerHTML="",MagicBoard.changed=!0},Sheet.prototype.totalShapeArea=function(){},Sheet.prototype.addShape=function(e){this.shapes.push(e),MagicBoard.changed=!0},Sheet.prototype.removeLastShape=function(){var e=MagicBoard.sheetBook.maxRedo;if(0!==this.shapes.length){var t=this.shapes[this.shapes.length-1];this.removedShapes.push(t),this.removedShapes.length>e&&this.removedShapes.splice(0,1),this.shapes.pop(),MagicBoard.changed=!0}},Sheet.prototype.removeShape=function(e){if(0!==this.shapes.length)for(var t=this.shapes.length-1;t>-1;t--){var i=this.shapes[t];if(i===e)return this.shapes.splice(t,1),void(MagicBoard.changed=!0)}},Sheet.prototype.reDraw=function(){this.wipe();for(var e=this.shapes.length,t=0;e>t;t++){var i=this.shapes[t];i.createCanvas(),i.draw()}},Sheet.prototype.undo=function(){this.removeLastShape(),this.reDraw(),MagicBoard.changed=!0},Sheet.prototype.redo=function(){0!==this.removedShapes.length&&(this.shapes.push(this.removedShapes[0]),this.removedShapes.splice(0,1),this.reDraw(),MagicBoard.changed=!0)},Sheet.prototype.align=function(){for(var e=this.shapes.length,t=0;e>t;t++)for(var i=this.shapes[t],a=i.frame.cx,o=i.frame.cy,r=t+1;e>r;r++){var n=this.shapes[r];if(!(n instanceof ConnectorLine)){var s=n.frame.cx,h=n.frame.cy,c={x:n.frame.left,y:n.frame.top},l=!1;Math.abs(a-s)<26&&a!==s&&(c.x=a-n.frame.width/2,l=!0),Math.abs(o-h)<26&&o!==h&&(c.y=o-n.frame.height/2,l=!0),l&&(n.setPosition(c),MagicBoard.changed=!0)}}},Sheet.prototype.refreshConnections=function(){for(var e=this.shapes.length,t=0;e>t;t++){var i=this.shapes[t];i.refreshConnection()}},Sheet.prototype.getImage=function(e){for(var t=this.canvas.cloneNode(),i=this.shapes,a=i.length,o=9999,r=9999,n=0,s=0,h=0;a>h;h++){var c=i[h],l=c.drawSVG();t.appendChild(l);var d=c.frame;d.left<o&&(o=d.left),d.top<r&&(r=d.top),d.right>n&&(n=d.right),d.bottom>s&&(s=d.bottom)}n+=10,s+=10,t.setAttribute("x",0),t.setAttribute("y",0),t.setAttribute("width",n),t.setAttribute("height",s),t.style.width=n+"px",t.style.height=s+"px";var p=new XMLSerializer,m=p.serializeToString(t);if("svg"===e)return{dataURL:m,size:{width:n,height:s}};var g=document.createElement("IMG");g.src="data:image/svg+xml;utf8,"+encodeURI(m);var f=document.createElement("canvas");f.height=s,f.width=n;var u=f.getContext("2d");u.drawImage(g,0,0,f.width,f.height);var v=f.toDataURL();return{dataURL:v,size:{width:f.width,height:f.height}}},Sheet.prototype.getConnection=function(e,t){for(var i=this.connections,a=i.length,o=0;a>o;o++){var r=i[o];if(r.beginShape===e&&r.endShape===t)return r}},Sheet.prototype.addConnections=function(e){for(var t=e.beginShape,i=e.endShape,a=this.connections,o=a.length,r=!1,n=0;o>n;n++){var s=a[n],h=e.pos;if(s.beginShape===t&&s.endShape===i)return r=!0,s.pos=h,s.orientation=e.orientation,s}return r||a.push(e),e},Sheet.prototype.findShapeByPosition=function(e){for(var t=[],i=0,a=this.shapes.length;a>i;i++){var o=this.shapes[i];o.contains(e)&&t.push(o)}return t},Sheet.prototype.save=function(){var e={};e.options=this.options,e.name=this.name,e.shapes=[];for(var t=0,i=this.shapes.length;i>t;t++){var a=this.shapes[t],o=a.save();o&&e.shapes.push(o)}return e},Sheet.prototype.changeThemeColor=function(e,t,i,a,o){e&&(MagicBoard.theme.backgroundColor=e),t&&(MagicBoard.theme.shapeColor=t),i&&(MagicBoard.theme.arrowFillColor=i),a&&(MagicBoard.theme.borderColor=a),o&&(MagicBoard.theme.lineColor=o);for(var r=0,n=this.shapes.length;n>r;r++){var s=this.shapes[r];s.changeThemeColor(t,a,o)}},Sheet.prototype.removeConnections=function(e){var t=e.connectedFrom;if(t){for(var i=(t.length,0);r>i;i++){var a=t[i];Utility.Sheet.removeConnection(this,a,e)}var o=e.connectedTo;if(o)for(var r=o.length,n=0;r>n;n++){var s=o[n];Utility.Sheet.removeConnection(this,e,s)}}},Sheet.prototype.drawConnections=function(e){e||setTimeout(function(){Utility.SheetBook.clearScratchCanvas()},700);for(var t=this.connections,i=t.length,a=0;i>a;a++){var o=t[a];o.shape&&(o.shape.deleteShape(!0),o.shape=null);var r=new ConnectorLine(o);r.draw()}};var Point=function(e,t){this.x=e,this.y=t},DrawingObject=function(){this.draw=function(){}},Shape=function(e){if(this.param=JSON.parse(JSON.stringify(e.param)),this.originalFrame=JSON.parse(JSON.stringify(e.frame)),this.frame=JSON.parse(JSON.stringify(e.frame)),e.typeId?(this.typeId=e.typeId,e.id?this.id=e.id:this.id=e.id+MagicBoard.counter):e.id?(this.typeId=e.id,this.id=e.id+MagicBoard.counter):this.id="s"+MagicBoard.counter,MagicBoard.counter++,e.parentId&&(e.parent=Utility.Sheet.findShapeById(e.parentId)),e.parent){this.param.alignmentRails=!1,this.param.noGridBlock=!0,this.parentShape=e.parent,this.parentId=this.parentShape.id;var t=this.parentShape.dimension;t.left&&(this.frame.minLeft=t.left,this.frame.maxRight=t.left+t.width),t.top&&(this.frame.minTop=t.top,this.frame.maxBottom=t.top+t.height),this.parentShape.children.push(this)}var i="height",a=this.originalFrame[i];a&&("number"==typeof a?(this.frame[i]=this.originalFrame[i],delete this.originalFrame[i]):this.originalFrame[i].indexOf("%")>-1&&(this.frame[i]=Utility.Shape.dataFormatter(this.originalFrame[i],i,this))),i="width",a=this.originalFrame[i],a&&("number"==typeof a?(this.frame[i]=this.originalFrame[i],delete this.originalFrame[i]):this.originalFrame[i].indexOf("%")>-1&&(this.frame[i]=Utility.Shape.dataFormatter(this.originalFrame[i],i,this))),i="left",a=this.originalFrame[i],a&&("number"==typeof a?(this.frame[i]=this.originalFrame[i],delete this.originalFrame[i]):this.originalFrame[i].indexOf("%")>-1&&(this.frame[i]=Utility.Shape.dataFormatter(this.originalFrame[i],i,this))),i="top",a=this.originalFrame[i],a&&("number"==typeof a?(this.frame[i]=this.originalFrame[i],delete this.originalFrame[i]):this.originalFrame[i].indexOf("%")>-1&&(this.frame[i]=Utility.Shape.dataFormatter(this.originalFrame[i],i,this))),this.param.connectRules||(this.param.connectRules={}),this.frame.minLeft||(this.frame.minLeft=10),this.frame.minTop||(this.frame.minTop=10),e.events?this.events=e.events:this.events={click:{override:null,post:null,pre:null},hover:{override:null,post:null,pre:null},doubleClick:{override:null,post:null,pre:null}},e.connectedFromIds&&(this.connectedFromIds=e.connectedFromIds),e.connectedToIds&&(this.connectedToIds=e.connectedToIds),this.properties={},this.components=[];for(var o=e.componentParms.length,r=0;o>r;r++){var n=new ShapeComponent(e.componentParms[r]);this.components.push(n);for(var s in n.properties)this.properties[s]=!0}if(this.init(),e.childrenParms)for(var h=0,c=e.childrenParms.length;c>h;h++){var l=e.childrenParms[h];l.parent=this;new Shape(l)}};inheritsFrom(Shape,DrawingObject),Shape.prototype.init=function(){void 0==this.param.alignmentRails&&(this.param.alignmentRails=!0),this.occupiedGrids=[],this.children||(this.children=[]),this.components||(this.components=[]),this.currentSheet=MagicBoard.sheetBook.getCurrentSheet(),this.sheetCanvas=this.currentSheet.getCanvas(),this.frame&&this.createCanvas();this.dimension=this.frame,this.id||(this.id=this.currentSheet.shapes.length),this.currentSheet.addShape(this),this.connectedTo=[],this.connectedFrom=[],this.drawn=!1},Shape.prototype.getShapeDetail=function(){var e={};e.param=this.param,e.frame=this.frame,e.events=this.events,e.typeId=this.typeId,e.parentId=this.parentId,this.connectedFromIds&&(e.connectedFromIds=this.connectedFromIds),this.connectedToIds&&(e.connectedToIds=this.connectedToIds),e.id=this.id,e=JSON.parse(JSON.stringify(e)),e.componentParms=[];for(var t=this.components.length,i=0;t>i;i++){var a=this.components[i],o=a.getComponentDetails();e.componentParms.push(o)}var r=[];chLen=this.children.length;for(var n=0;n<chLen;n++){var s=this.children[n],h=s.getShapeDetail();r.push(h)}return r.length>0&&(_desc.childrenParms=r),e},Shape.prototype.createCanvas=function(){var e=Utility.Shape.dataFormatter(this.frame.width,"width",this);this.frame.width=e;var t=Utility.Shape.dataFormatter(this.frame.height,"height",this);this.frame.height=t;var i=document.createElementNS("http://www.w3.org/2000/svg","g");this.dom=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.dom.setAttribute("name","mg"),this.dom.setAttribute("width",e),this.dom.setAttribute("height",t),this.dom.setAttribute("pointer-events","all"),this.dom.setAttribute("style","position:absolute;-ms-user-select:none;-webkit-user-select:none;z-index:10;z-index:1"),this.dom.setAttribute("x",Utility.Shape.dataFormatter(this.frame.left,"left",this)),this.dom.setAttribute("y",Utility.Shape.dataFormatter(this.frame.top,"top",this)),i.appendChild(this.dom),this.sheetCanvas.appendChild(i)},Shape.prototype.addComponent=function(e){this.components.push(e)},Shape.prototype.addHover=function(){var e=this,t=this.dom;t.onmouseover=function(){e.currentSheet.active&&(MagicBoard.indicators.mouseover.push(e),MagicBoard.indicators.lineActive===e)},t.onmouseout=function(){if(e.currentSheet.active){event.preventDefault();for(var t=MagicBoard.indicators.mouseover.length-1;t>-1;t--)if(MagicBoard.indicators.mouseover[t]===e)return void MagicBoard.indicators.mouseover.splice(t,1)}}},Shape.prototype.click=function(){var e=this.events;if(e){if(e.click||(e.click={override:null,pre:null,post:null}),e.click.override)return window[e.click.override].call(this);e.click.pre&&window[e.click.pre].call(this)}this.selectToggle()},Shape.prototype.doubleClick=function(){var e=this.events;if(e){if(e.doubleClick||(e.doubleClick={override:null,pre:null,post:null}),e.doubleClick.override)return window[e.doubleClick.override].call(this);e.doubleClick.pre&&window[e.doubleClick.pre].call(this)}var t=event.target;t instanceof SVGTextElement},Shape.prototype.move=function(e,t){var i=this.getDimension(),a=e.y-t.y,o=e.x-t.x,r=i.top+a,n=i.bottom+a,s=i.left+o,h=i.right+o,c=MagicBoard.sheetBook.scratchCtx,l=MagicBoard.sheetBook.scratchCanvas;if(MagicBoard.scratch.prevAlign){if(MagicBoard.scratch.prevAlign.top&&(Math.abs(r-MagicBoard.scratch.prevAlign.top)<8?r=MagicBoard.scratch.prevAlign.top:delete MagicBoard.scratch.prevAlign.top),MagicBoard.scratch.prevAlign.left&&(Math.abs(s-MagicBoard.scratch.prevAlign.left)<8?s=MagicBoard.scratch.prevAlign.left:delete MagicBoard.scratch.prevAlign.left),MagicBoard.scratch.prevAlign.bottom)if(Math.abs(n-MagicBoard.scratch.prevAlign.bottom)<8){n=MagicBoard.scratch.prevAlign.bottom;var d=n-i.bottom;r=i.top+d}else delete MagicBoard.scratch.prevAlign.bottom;if(MagicBoard.scratch.prevAlign.right)if(Math.abs(h-MagicBoard.scratch.prevAlign.right)<8){h=MagicBoard.scratch.prevAlign.right;var d=h-i.right;s=i.left+d}else delete MagicBoard.scratch.prevAlign.right;var p=!1;for(var m in MagicBoard.scratch.prevAlign){p=!0;break}p||(delete MagicBoard.scratch.prevAlign,c.clearRect(0,0,l.width,l.height))}else{var p=this.alignmentCheck(c,l.width,l.height,r,s,n,h);p||c.clearRect(0,0,l.width,l.height)}c.beginPath(),c.strokeStyle="green",c.setLineDash([2,2]),c.lineWidth=4,c.rect(s-2,r-2,i.width+4,i.height+4),c.stroke(),MagicBoard.changed=!0},Shape.prototype.resizeContinue=function(e,t){var i=(MagicBoard.sheetBook.hilighter,MagicBoard.indicators.resize);if(2>i){var a=e.x-t.x;Utility.Shape.resize(this,a,-1)}else if(4>i){var o=e.y-t.y;Utility.Shape.resize(this,-1,o)}else{var a=e.x-t.x,o=e.y-t.y;Utility.Shape.resize(this,a,o)}Utility.SheetBook.resizeHilighter(this.dimension,this)},Shape.prototype.resizeStop=function(){var e=(MagicBoard.indicators.resizeStarted,MagicBoard.indicators.click,{x:this.dimension.left,y:this.dimension.top},MagicBoard.sheetBook.hilighter);e.style.visibility="hidden",e.style.transform="",this.dom.style.transform="",this.dimension.resizeX=null,this.dimension.resizeY=null,this.dimension.resizeWidth=null,this.dimension.resizeHeight=null;var t=null;this.parentShape&&(t=this.parentShape.frame),Utility.Shape.definePeriferalPoints(this.dimension,t),MagicBoard.indicators.resize=-1,MagicBoard.indicators.resizeStarted=null,this.selectToggle();var i={},a=!1;for(var o in this.originalFrame)if("height"===o||"width"===o){var r=Utility.Shape.dataFormatter(this.originalFrame[o],o,this);if(r===this.frame[o])continue;a=!0,i[o]=this.frame[o]-r,this.frame[o]=r}if(a){for(var n=this,s=!1;n.parentShape;){s=!0;var h=this.parentShape;h&&(n=h)}(s||n.children.length>0)&&Utility.Shape.adjustComponents(n,i)}else this.children.length>0&&Utility.Shape.adjustComponents(this,{});MagicBoard.changed=!0},Shape.prototype.lineTo=function(e){var t=MagicBoard.sheetBook.scratchCtx;t.lineTo(e.x,e.y),t.stroke()},Shape.prototype.refreshConnection=function(e){for(var t=this.currentSheet,i=this.connectedFrom,a=i.length,o=0;a>o;o++){var r=i[o],n=t.getConnection(r,this);Utility.Shape.reCalculateConnectionPoints(n),t.drawConnections(e)}for(var s=this.connectedTo,h=s.length,c=0;h>c;c++){endShape=s[c];var n=t.getConnection(this,endShape);Utility.Shape.reCalculateConnectionPoints(n),t.drawConnections(e)}},Shape.prototype.connectFrom=function(e){for(var t=this.connectedFrom,i=!1,a=t.length,o=0;a>o;o++){var r=t[o];if(e===r){i=!0;break}}i||this.connectedFrom.push(e)},Shape.prototype.connectTo=function(e,t){var i=this.events;if(!t){if(i&&i.connectTo&&i.connectTo.override)return void window[i.connectTo.override].call(this,e);t={type:"TWOBEND",end:"FILLED",begin:null}}Utility.Shape.connectTo(this,e,t)},Shape.prototype.alignmentCheck=function(e,t,i,a,o,r,n,s){var h=!1,c=[];if(MagicBoard.sheetBook.alignments.x[a]&&(c.push("top"),h=!0,MagicBoard.scratch.prevAlign||(MagicBoard.scratch.prevAlign={}),MagicBoard.scratch.prevAlign.top=a),MagicBoard.sheetBook.alignments.x[r]&&(c.push("bottom"),h=!0,MagicBoard.scratch.prevAlign||(MagicBoard.scratch.prevAlign={}),MagicBoard.scratch.prevAlign.bottom=r),MagicBoard.sheetBook.alignments.y[o]&&(c.push("left"),h=!0,MagicBoard.scratch.prevAlign||(MagicBoard.scratch.prevAlign={}),MagicBoard.scratch.prevAlign.left=o),MagicBoard.sheetBook.alignments.y[n]&&(c.push("right"),h=!0,MagicBoard.scratch.prevAlign||(MagicBoard.scratch.prevAlign={}),MagicBoard.scratch.prevAlign.right=n),c.length>0){e.beginPath(),e.strokeStyle="gray",e.lineWidth=1,e.setLineDash([5,5]);for(var l=c.length-1;l>-1;l--){var d=c[l];switch(d){case"top":e.moveTo(0,a),e.lineTo(t,a);break;case"bottom":e.moveTo(0,r),e.lineTo(t,r);break;case"left":e.moveTo(o,0),e.lineTo(o,i);break;case"right":e.moveTo(n,0),e.lineTo(n,i)}}e.stroke(),e.setLineDash([5,0])}return h},Shape.prototype.contains=function(e){var t=this.dimension;return e.x>t.left&&e.x<t.left+t.width&&e.y>t.top&&e.y<t.top+t.height?!0:!1},Shape.prototype.setPosition=function(e,t){this.param.alignmentRails&&this.removeAlignments();var i=this.frame,a=null;this.parentShape&&(a=this.parentShape.dimension,this.frame.minLeft=a.left,this.frame.maxRight=a.left+a.width,this.frame.minTop=a.top,this.frame.maxBottom=a.top+a.height),e.diffX?(i.left&&(e.x=i.left+e.diffX),i.top&&(e.y=i.top+e.diffY)):a&&(i.offsetX&&(e.x=a.left+i.offsetX),i.offsetY&&(e.y=a.top+i.offsetY));var o=this.frame.maxRight;o||(o=MagicBoard.sheetBook.cwidth);var r=this.frame.maxBottom;r||(r=MagicBoard.sheetBook.cheight),e.x<this.frame.minLeft&&(e.x=this.frame.minLeft),e.y<this.frame.minTop&&(e.y=this.frame.minTop),o<e.x+i.width&&(this.parentShape?e.x=this.frame.maxRight-i.width:MagicBoard.sheetBook.setWidth(MagicBoard.sheetBook.cwidth+512)),r<e.y+i.height&&(this.parentShape?e.y=this.frame.maxBottom-i.height:MagicBoard.sheetBook.setHeight(MagicBoard.sheetBook.cheight+512)),t&&(e=Utility.Shape.align(e)),this.dom.setAttribute("x",e.x),this.dom.setAttribute("y",e.y),i.left=e.x,i.top=e.y,Utility.Shape.definePeriferalPoints(i,a),Utility.Shape.placement(this),this.refreshConnection(),this.param.alignmentRails&&this.addAlignments(),this.param.noGridBlock||Utility.Shape.blockGrids(this);for(var n=0,s=this.children.length;s>n;n++){var h=this.children[n],c=(h.frame,h.originalFrame),l={x:e.x,y:e.y};if(e.diffX&&(l.diffX=e.diffX,l.diffY=e.diffY),c.left){var d=Utility.Shape.dataFormatter(c.left,"left",h);l.x=d}if(c.top){var d=Utility.Shape.dataFormatter(c.top,"top",h);l.y=d}h.setPosition(l)}this.drawn||this.draw()},Shape.prototype.setDimension=function(e){this.dimension={left:e.left,right:e.right,top:e.top,bottom:e.bottom,width:e.width,height:e.height},this.addAlignments()},Shape.prototype.removeAlignments=function(){var e=function(e,t){if(!e)return!1;var i=e.length;if(2>i)return!1;for(var a=i-1;a>-1;a--){var o=e[a];if(o===t)return void e.splice(a,1)}},t=this.dimension,i=e(MagicBoard.sheetBook.alignments.y[t.left],this);i||(MagicBoard.sheetBook.alignments.y[t.left]=null),i=e(MagicBoard.sheetBook.alignments.y[t.right],this),i||(MagicBoard.sheetBook.alignments.y[t.right]=null),i=e(MagicBoard.sheetBook.alignments.y[t.cx],this),i||(MagicBoard.sheetBook.alignments.y[t.cx]=null),i=e(MagicBoard.sheetBook.alignments.x[t.top],this),i||(MagicBoard.sheetBook.alignments.x[t.top]=null),i=e(MagicBoard.sheetBook.alignments.x[t.bottom],this),i||(MagicBoard.sheetBook.alignments.x[t.bottom]=null),i=e(MagicBoard.sheetBook.alignments.x[t.cy],this),i||(MagicBoard.sheetBook.alignments.x[t.cy]=null)},Shape.prototype.addAlignments=function(){var e=this.dimension;MagicBoard.sheetBook.alignments.y[e.left]||(MagicBoard.sheetBook.alignments.y[e.left]=[]),MagicBoard.sheetBook.alignments.y[e.left].push(this),MagicBoard.sheetBook.alignments.y[e.right]||(MagicBoard.sheetBook.alignments.y[e.right]=[]),MagicBoard.sheetBook.alignments.y[e.right].push(this),MagicBoard.sheetBook.alignments.y[e.cx]||(MagicBoard.sheetBook.alignments.y[e.cx]=[]),MagicBoard.sheetBook.alignments.y[e.cx].push(this),MagicBoard.sheetBook.alignments.x[e.top]||(MagicBoard.sheetBook.alignments.x[e.top]=[]),MagicBoard.sheetBook.alignments.x[e.top].push(this),MagicBoard.sheetBook.alignments.x[e.bottom]||(MagicBoard.sheetBook.alignments.x[e.bottom]=[]),MagicBoard.sheetBook.alignments.x[e.bottom].push(this),MagicBoard.sheetBook.alignments.x[e.cy]||(MagicBoard.sheetBook.alignments.x[e.cy]=[]),MagicBoard.sheetBook.alignments.x[e.cy].push(this)},Shape.prototype.getDimension=function(e){return this.dimension||this.setDimension(this.dom.getBoundingClientRect()),this.dimension},Shape.prototype.applyProperty=function(e,t,i,a,o,r){for(var n=0,s=this.components.length;s>n;n++){var h=this.components[n],c=h.properties[e];c&&c.label===o&&c.group===r&&h.applyProperty(t,i,a,o,r)}MagicBoard.changed=!0},Shape.prototype.getProperties=function(){for(var e=[],t=0,i=this.components.length;i>t;t++){var a=this.components[t];for(var o in a.properties){var r=JSON.parse(JSON.stringify(MagicBoard.properties[o])),n=a.properties[o];r.group=n.group,r.label=n.label,r.keyName=o;var s=a.param[r.propName];if("text"===o&&(s=a.innerHTML),s)if("input"===r.field)r.values[0].value=s;else if("select"===r.field)for(var h=0,c=r.values.length;c>h;h++)r.values[h].value==s&&(r.values[h].selected=!0);e[e.length]=r}}return e},Shape.prototype.getDom=function(){return this.dom},Shape.prototype.setPoints=function(e){this.points=e},Shape.prototype.getArea=function(){},Shape.prototype.deleteShape=function(){MagicBoard.sheetBook.currentSheet.removeShape(this);var e=MagicBoard.sheetBook.garbage,t=this.dom.parentNode;e.appendChild(t),e.innerHTML="";for(var i=(this.id,this.children.length-1);i>-1;i--)this.children[i].deleteShape();if(this.parentShape)for(var a=this.parentShape.children,o=a.length-1;o>-1;o--){var r=a[o];if(r===this){a.splice(o,1);break}}for(var n in this)if("object"==typeof this[n]){if("connectedTo"===n){this.connectedTo;MagicBoard.sheetBook.currentSheet.removeConnections(this),MagicBoard.sheetBook.currentSheet.drawConnections()}else"connectedFrom"===n&&(MagicBoard.sheetBook.currentSheet.removeConnections(this),MagicBoard.sheetBook.currentSheet.drawConnections());this[n]=null}MagicBoard.changed=!0},Shape.prototype.selectToggle=function(){var e=this.getDimension(),t=MagicBoard.sheetBook.scratchCtx,i=MagicBoard.sheetBook.scratchCanvas;t.clearRect(0,0,i.width,i.height);var a=MagicBoard.sheetBook.hilighter;if(MagicBoard.indicators.hilight)a.style.visibility="hidden",setTimeout(function(){var e=MagicBoard.indicators.hilight;MagicBoard.indicators.hilight=!1,e.events&&e.events.click&&e.events.click.post&&window[e.events.click.post].call(e)},1),this.addAlignments();else{var o=e.left,r=e.top;this.parentShape;Utility.SheetBook.activateHilighter({left:o,top:r,width:e.width,height:e.height},this),MagicBoard.indicators.hilight=this,this.removeAlignments(),this.events.click.post&&window[this.events.click.post].call(this)}},Shape.prototype.updateText=function(e,t){void 0==t&&(t=0);for(var i=0,a=0,o=this.components.length;o>a;a++){var r=this.components[a];if("text"===r.type){if(i===t){r.updateText(e);break}i++}}MagicBoard.changed=!0},Shape.prototype.save=function(){var e={};for(var t in this)if("cInfo"!==t)if("components"!==t)if("connectedFrom"!==t&&"connectedTo"!==t){if(this[t]){var i=this[t].constructor.name;("Number"===i||"String"===i||"Object"===i)&&(e[t]=this[t])}}else{e[t+"Ids"]=[];for(var a=this[t].length,o=0;a>o;o++){var r=this[t][o];e[t+"Ids"].push(r.id)}}else{e.componentParms=[];for(var a=this.components.length,o=0;a>o;o++){var n=this.components[o];e.componentParms.push(n.save())}}return e},Shape.prototype.rotate=function(e){},Shape.prototype.draw=function(){var e=this.dom;e.innerHTML="";var t=document.createElementNS("http://www.w3.org/2000/svg","g");e.appendChild(t),this.reDraw(t);var i=this.events;i&&i.hover&&i.hover.override?window[i.hover.override].call(this):this.addHover(),this.drawn=!0},Shape.prototype.reDraw=function(e){var t=!0;e||(e=this.dom.firstElementChlid,t=!1);for(var i=this.components.length,a=0;i>a;a++){var o=this.components[a];o.parentShape=this;var r=o.construct();t&&r&&e.appendChild(r)}this.refreshConnection()},Shape.prototype.drawOnCanvas=function(e){e.beginPath();for(var t=this.components.length,i=0;t>i;i++){var a=this.components[i];a.drawOnCanvas(e)}e.stroke(),this.refreshConnection(e)},Shape.prototype.drawSVG=function(){for(var e=document.createElementNS("http://www.w3.org/2000/svg","g"),t=this.frame.left,i=this.frame.top,a=this.components.length,o=0;a>o;o++){var r=this.components[o],n=r.drawSVG(t,i);e.appendChild(n)}return e},Shape.prototype.changeThemeColor=function(e,t,i){e||(e=MagicBoard.theme.shapeColor),t||(t=MagicBoard.theme.borderColor);for(var a=this.components.length,o=0;a>o;o++){var r=this.components[o];r.changeThemeColor(e,t)}};var ConnectorLine=function(e){var t=this;this.cInfo=e;var i=Utility.Shape.defineConnectionCoordinates(this,e);this.param={alignmentRails:!1,noGridBlock:!0},this.components=[];var a={type:"path",origDim:{},dimension:{d:i.d},param:{fill:"none",stroke:MagicBoard.theme.lineColor,"stroke-miterlimit":"10","stroke-width":2,cursor:"hand"},lines:i.lines,properties:{"line-style":!0,"line-type":!0,"line-color":!0,"start-marker":!0,"end-marker":!0,"mid-marker":!0}};if(e.param&&(a.param=e.param),e.properties&&(a.properties=e.properties),e.connProp.style){var o=e.connProp.style;"DASHED"===o?a.param["stroke-dasharray"]="10,5":"DOTTED"===o?a.param["stroke-dasharray"]="1,4":"SOLID"===o&&a.param["stroke-dasharray"]&&delete a.param["stroke-dasharray"]}var r=new ShapeComponent(a);if(this.components.push(r),e.connProp.begin){var n=e.connProp.begin,s=Drawing.createArrowPath("start",n,this.cInfo.angleStart,{x:this.cInfo.pos.x1,y:this.cInfo.pos.y1},this.frame);this.components.push(s)}if(e.connProp.end){var h=e.connProp.end,s=Drawing.createArrowPath("end",h,this.cInfo.angleEnd,{x:this.cInfo.pos.x2,y:this.cInfo.pos.y2},this.frame);this.components.push(s)}this.properties=r.properties,e.events&&(this.events=e.events);var c=r.dom;c.onmouseover=function(){MagicBoard.indicators.mouseover.push(t);var e=MagicBoard.getPos(event),i=MagicBoard.sheetBook.star.style;i.display="block",i.left=e.x-10,i.top=e.y-10,MagicBoard.sheetBook.star.cLine=t},c.onmouseout=function(){event.preventDefault(),setTimeout(function(){MagicBoard.sheetBook.star.style.display="none";
},300);for(var e=MagicBoard.indicators.mouseover.length-1;e>-1;e--)if(MagicBoard.indicators.mouseover[e]===t)return void MagicBoard.indicators.mouseover.splice(e,1)},this.init(),e.shape=this,e.properties=r.properties,e.param=r.param};inheritsFrom(ConnectorLine,Shape),ConnectorLine.prototype.changeThemeColor=function(e,t,i){e=MagicBoard.theme.arrowFillColor,i||(i=MagicBoard.theme.lineColor);for(var a=this.components.length,o=0;a>o;o++){var r=this.components[o];r.changeThemeColor(e,i)}},ConnectorLine.prototype.save=function(){var e={typeId:"ConnectorLine",angleEnd:0,angleStart:0,beginShapeId:null,endShapeId:null,connProp:{begin:null,end:null,style:"",type:""},param:{},pos:{x1:null,y1:null,x2:null,y2:null,pointStart:{label:""},pointEnd:{label:""}},shapeId:"",turningPoints:[]},t=this.cInfo;return e.angleStart=t.angleStart,e.angleEnd=t.angleEnd,e.beginShapeId=t.beginShape.id,e.endShapeId=t.endShape.id,e.connProp=t.connProp,e.param=t.param,e.pos.x1=t.pos.x1,e.pos.x2=t.pos.x2,e.pos.y1=t.pos.y1,e.pos.y2=t.pos.y2,e.pos.pointStart=t.pos.pointStart,e.pos.pointEnd=t.pos.pointEnd,e.turningPoints=t.turningPoints,e.properties=t.properties,e.shapeId=t.shape.id,e.events=t.events,e},ConnectorLine.prototype.drawOnCanvas=function(e){e.beginPath();for(var t=this.components.length,i=0;t>i;i++){var a=this.components[i];if(a.drawOnCanvas(e),a.param["marker-end"]){var o=a.param["marker-end"];o="url(#fillArrowE)"===o?"Filled":"url(#hollowArrowE)"===o?"Hollow":"url(#hollowDiamond)"===o?"DiamondHollow":"url(#fillDiamond)"===o?"DiamondFilled":"url(#dot)"===o?"Dot":"Regular";var r=a.lines,n=r[r.length-1];Drawing.drawArrow(e,n.x+this.dimension.left,n.y+this.dimension.top,this.cInfo.angleEnd,o,a.param.fill,a.param.stroke)}if(a.param["marker-start"]){var o=a.param["marker-start"];o="url(#fillArrowS)"===o?"Filled":"url(#hollowArrowS)"===o?"Hollow":"url(#hollowDiamond)"===o?"DiamondHollow":"url(#fillDiamond)"===o?"DiamondFilled":"url(#dot)"===o?"Dot":"Regular";var r=a.lines,s=r[0];Drawing.drawArrow(e,s.x+this.dimension.left,s.y+this.dimension.top,this.cInfo.angleStart,o,a.param.fill,a.param.stroke)}}e.stroke()},ConnectorLine.prototype.deleteShape=function(e){var t=this.cInfo.beginShape,i=this.cInfo.endShape;MagicBoard.sheetBook.currentSheet.removeShape(this);var a=MagicBoard.sheetBook.garbage,o=this.dom.parentNode;if(a.appendChild(o),a.innerHTML="",!e){for(var r=this.currentSheet.connections,n=0,s=r.length;s>n;n++){var h=r[n];if(h.beginShape===t&&h.endShape===i){r.splice(n,1);break}}for(var c in this.cInfo)"object"==typeof this.cInfo[c]&&(this.cInfo[c]=null);for(var l=t.connectedTo,n=0,s=l.length;s>n;n++){var d=l[n];if(d===i){l.splice(n,1);break}}for(var p=i.connectedFrom,n=0,s=p.length;s>n;n++){var d=p[n];if(d===t){p.splice(n,1);break}}}for(var c in this)"object"==typeof this[c]&&(this[c]=null)};var ShapeComponent=function(e){for(var t in e)this[t]=e[t];this.parentShape=null,this.dom=document.createElementNS("http://www.w3.org/2000/svg",this.type);for(var t in this.param)"border-radius"===t?(this.dom.setAttribute("rx",this.param[t]),this.dom.setAttribute("ry",this.param[t])):this.dom.setAttribute(t,this.param[t]);this.dom.setAttribute("pointer-events","all"),this.dom.setAttribute("draggable","false"),this.dom.setAttribute("name","mg"),this.derivedDimension={},this.properties||(this.properties={})};ShapeComponent.prototype.getComponentDetails=function(){var e={};return e.type=this.type,e.dimension=JSON.parse(JSON.stringify(this.dimension)),e.param=JSON.parse(JSON.stringify(this.param)),this.innerHTML&&(e.innerHTML=this.innerHTML),this.properties&&(e.properties=this.properties),e},ShapeComponent.prototype.construct=function(){if(this.parentShape){var e=this.dom;this.derivedDimension=this.calculateDimensions();for(var t in this.derivedDimension)this.dom.setAttribute(t,this.derivedDimension[t]);if("image"===this.type){var i=this.xlink;this.dom.setAttributeNS("http://www.w3.org/1999/xlink","href",i)}if(this.derivedParam&&this.derivedParam.transform)for(var a=this.derivedParam.transform.trim(),o=a.split(" "),r=o.length-1;r>-1;r--){var n=o[r];if(n.indexOf("translate")>-1){var s=n.indexOf("(")+1,h=n.indexOf(")");n.substring(s,h)}}return this.innerHTML&&Utility.ShapeComponent.createTextNode(this),e}},ShapeComponent.prototype.save=function(){var e={};for(var t in this){var i=this[t].constructor.name;("String"===i||"Object"===i)&&(e[t]=this[t])}return e},ShapeComponent.prototype.calculateDimensions=function(e,t){var i={};e||(e=0),t||(t=0);var a=0;this.param["stroke-width"]&&(a=parseInt(this.param["stroke-width"]));var o=this.parentShape.frame.width-2*a,r=this.parentShape.frame.height-2*a;this.mapping&&(o=this.parentShape.frame[this.mapping.x.parm],r=this.parentShape.frame[this.mapping.y.parm],this.mapping.x.multiplier&&(o*=this.mapping.x.multiplier),this.mapping.y.multiplier&&(r*=this.mapping.y.multiplier));for(var n in this.dimension){var s="",h=this.dimension[n];switch(n){case"width":s=h*o/100-2*a;break;case"x":case"x1":case"x2":case"cx":s=h*o/100+a+e;break;case"rx":case"r":s=h*o/100-a;break;case"height":s=h*r/100-2*a;break;case"y":case"y1":case"y2":case"cy":s=h*r/100+a+t;break;case"ry":s=h*r/100-a;break;case"d":case"points":this.lines||(this.lines=[]);for(var c=h,l=c.length,d=0;l>d;d++){var p=c[d];if("Z"===p.op.toUpperCase()){s+=" Z ";break}this.lines[d]||this.lines.push({});for(var m in p){var g=p[m];m.indexOf("x")>-1?g=Math.round(p[m]*o/100)+e:m.indexOf("y")>-1&&(g=Math.round(p[m]*r/100)+t),this.lines[d][m]=g,s+=g+" "}}break;case"offsetX":var f=i.x;0===f||f?i.x=f+this.dimension[n]:e=this.dimension[n];break;case"offsetY":var u=i.y;0===u||u?i.y=u+this.dimension[n]:t=this.dimension[n]}(0===s||s)&&(i[n]=s)}if("text"===this.type||"rect"===this.type){this.dom;if(this.dimension.cx){var f=i.cx-i.width/2+e;i.x=f}if(this.dimension.cy){var u=i.cy-i.height/2+t;i.y=u}}return i},ShapeComponent.prototype.drawSVG=function(e,t){var i=this.dom.cloneNode(),a=this.calculateDimensions(e,t);for(var o in a){var r=a[o];i.setAttribute(o,r)}if("image"===this.type){var n=this.xlink;i.setAttributeNS("http://www.w3.org/1999/xlink","href",n)}else if("text"===this.type){i.innerHTML=this.dom.innerHTML;for(var s=this.dom.children,h=0,c=s.length;c>h;h++){var l=s[h];l.removeAttribute("x")}}return i},ShapeComponent.prototype.changeThemeColor=function(e,t){e||(e=MagicBoard.theme.shapeColor),t||(t=MagicBoard.theme.lineColor),"text"===this.type&&(e=MagicBoard.theme.textColor);var i=this.dom;e&&this.param.fill&&(this.param.fill=e,i.setAttribute("fill",e)),t&&this.param.stroke&&(this.param.stroke=t,i.setAttribute("stroke",t))},ShapeComponent.prototype.drawOnCanvas=function(e){var t=this.parentShape.dimension.left,i=this.parentShape.dimension.top,a=0;this.param["stroke-width"]&&(a=parseInt(this.param["stroke-width"]));var o=this.derivedDimension.x+t,r=this.derivedDimension.y+i;o||(o=t),r||(r=i);var n=this.param.fill;"none"===n&&(n="");var s=!1;if(this.param["stroke-dasharray"]){var h=this.param["stroke-dasharray"],c=h.split(",");e.setLineDash(c),s=!0}switch(this.type){case"rect":n?(e.fillStyle=n,e.fillRect(o,r,this.derivedDimension.width,this.derivedDimension.height)):e.strokeRect(o,r,this.derivedDimension.width,this.derivedDimension.height);break;case"circle":break;case"ellipse":var l=this.derivedDimension.cx+t,d=this.derivedDimension.cy+i;Drawing.drawEllipse(e,l,d,this.derivedDimension.rx,this.derivedDimension.ry,n,this.param.stroke);break;case"path":Drawing.drawLines(e,t,i,this.derivedDimension.d,n,this.param.stroke,a);break;case"polyline":break;case"text":n&&(e.fillStyle=n),this.param.stroke&&(e.strokeStyle=this.param.stroke),e.fillText(this.innerHTML,o,r)}s&&e.setLineDash([])},ShapeComponent.prototype.applyProperty=function(e,t,i,a,o){"attribute"===t?i?(this.dom.setAttribute(e,i),this.param[e]=i):(this.dom.removeAttribute(e),delete this.param[e]):"dom"===t&&(this.innerHTML=i,Utility.ShapeComponent.createTextNode(this))},ShapeComponent.prototype.updateText=function(e){this.innerHTML=e,Utility.ShapeComponent.createTextNode(this)};var Drawing={};Drawing.getLineAngle=function(e,t,i,a){return Math.atan2(t-a,e-i)},Drawing.getArrowHead=function(e,t,i){var a,o,r,n,s=10;return a=e-s*Math.cos(i-Math.PI/6),r=t-s*Math.sin(i-Math.PI/6),o=e-s*Math.cos(i+Math.PI/6),n=t-s*Math.sin(i+Math.PI/6),{x1:a,x2:o,y1:r,y2:n}},Drawing.createArrowPath=function(e,t,i,a,o){var r,n,s,h,c=[],l=o.width,d=o.height,p=o.left,m=o.top,g=15;r=a.x-g*Math.cos(i-Math.PI/6),s=a.y-g*Math.sin(i-Math.PI/6),n=a.x-g*Math.cos(i+Math.PI/6),h=a.y-g*Math.sin(i+Math.PI/6);var f={properties:{}};switch(t){case"REGULAR":c[0]={op:"M",x:100*(a.x-p)/l,y:100*(a.y-m)/d},c[1]={op:"L",x:100*(r-p)/l,y:100*(s-m)/d},c[2]={op:"M",x:100*(a.x-p)/l,y:100*(a.y-m)/d},c[3]={op:"L",x:100*(n-p)/l,y:100*(h-m)/d},f.type="path",f.dimension={d:c},f.param={fill:"none",stroke:MagicBoard.theme.lineColor,"stroke-miterlimit":"10","stroke-width":2};break;case"FILLED":c[0]={op:"M",x:100*(a.x-p)/l,y:100*(a.y-m)/d},c[1]={op:"L",x:100*(r-p)/l,y:100*(s-m)/d},c[2]={op:"L",x:100*(n-p)/l,y:100*(h-m)/d},c[3]={op:"L",x:100*(a.x-p)/l,y:100*(a.y-m)/d},c[4]={op:"Z"},f.type="path",f.dimension={d:c},f.param={fill:MagicBoard.theme.arrowFillColor,stroke:MagicBoard.theme.lineColor,"stroke-miterlimit":"10","stroke-width":2};break;case"HOLLOW":c[0]={op:"M",x:100*(a.x-p)/l,y:100*(a.y-m)/d},c[1]={op:"L",x:100*(r-p)/l,y:100*(s-m)/d},c[2]={op:"L",x:100*(n-p)/l,y:100*(h-m)/d},c[3]={op:"L",x:100*(a.x-p)/l,y:100*(a.y-m)/d},c[4]={op:"Z"},f.type="path",f.dimension={d:c},f.param={fill:"white",stroke:MagicBoard.theme.lineColor,"stroke-miterlimit":"10","stroke-width":2};break;case"DIAMONDFILLED":var u=s+h-a.y,v=r+n-a.x;c[0]={op:"M",x:100*(a.x-p)/l,y:100*(a.y-m)/d},c[1]={op:"L",x:100*(r-p)/l,y:100*(s-m)/d},c[2]={op:"L",x:100*(v-p)/l,y:100*(u-m)/d},c[3]={op:"L",x:100*(n-p)/l,y:100*(h-m)/d},c[4]={op:"L",x:100*(a.x-p)/l,y:100*(a.y-m)/d},c[5]={op:"Z"},f.type="path",f.dimension={d:c},f.param={fill:MagicBoard.theme.arrowFillColor,stroke:MagicBoard.theme.lineColor,"stroke-miterlimit":"10","stroke-width":2};break;case"DIAMONDHOLLOW":var u=s+h-a.y,v=r+n-a.x;c[0]={op:"M",x:100*(a.x-p)/l,y:100*(a.y-m)/d},c[1]={op:"L",x:100*(r-p)/l,y:100*(s-m)/d},c[2]={op:"L",x:100*(v-p)/l,y:100*(u-m)/d},c[3]={op:"L",x:100*(n-p)/l,y:100*(h-m)/d},c[4]={op:"L",x:100*(a.x-p)/l,y:100*(a.y-m)/d},c[5]={op:"Z"},f.type="path",f.dimension={d:c},f.param={fill:"white",stroke:MagicBoard.theme.lineColor,"stroke-miterlimit":"10","stroke-width":2};break;case"DOT":f.type="circle";var y=700/l,x=a.x-8*Math.cos(i),B=a.y-8*Math.sin(i);f.dimension={cx:100*(x-p)/l,cy:100*(B-m)/d,r:y},f.param={fill:MagicBoard.theme.shapeColor,stroke:MagicBoard.theme.lineColor,"stroke-miterlimit":"10","stroke-width":2}}var S=new ShapeComponent(f);return S},Drawing.drawArrow=function(e,t,i,a,o,r,n){o||(o="Regular"),r&&"none"!==r||(r="");var s,h,c,l,d=15;switch(s=t-d*Math.cos(a-Math.PI/6),c=i-d*Math.sin(a-Math.PI/6),h=t-d*Math.cos(a+Math.PI/6),l=i-d*Math.sin(a+Math.PI/6),e&&e.beginPath(),n&&(e.strokeStyle=n),o){case"Regular":e.moveTo(t,i),e.lineTo(s,c),e.moveTo(t,i),e.lineTo(h,l);break;case"Filled":e.moveTo(t,i),e.lineTo(s,c),e.lineTo(h,l),e.lineTo(t,i),!r&&n&&(r=n),e.fillStyle=r,e.fill();break;case"Hollow":e.moveTo(t,i),e.lineTo(s,c),e.lineTo(h,l),e.lineTo(t,i);break;case"DiamondFilled":var p=c+l-i,m=s+h-t;e.moveTo(t,i),e.lineTo(s,c),e.lineTo(m,p),e.lineTo(h,l),e.lineTo(t,i),!r&&n&&(r=n),e.fillStyle=r,e.fill();break;case"DiamondHollow":var p=c+l-i,m=s+h-t;e.moveTo(t,i),e.lineTo(s,c),e.lineTo(m,p),e.lineTo(h,l),e.lineTo(t,i);break;case"Dot":var g=t-5*Math.cos(a),f=i-5*Math.sin(a),u=5;e.arc(g,f,u,0,2*Math.PI),!r&&n&&(r=n),e.fillStyle=r,e.fill()}return e.stroke(),{x1:s,x2:h,y1:c,y2:l}},Drawing.roundRect=function(e,t,i,a,o,r,n,s){if("undefined"==typeof s&&(s=!0),"undefined"==typeof r&&(r=5),"number"==typeof r)r={tl:r,tr:r,br:r,bl:r};else{var h={tl:0,tr:0,br:0,bl:0};for(var c in h)r[c]=r[c]||h[c]}e.beginPath(),e.moveTo(t+r.tl,i),e.lineTo(t+a-r.tr,i),e.quadraticCurveTo(t+a,i,t+a,i+r.tr),e.lineTo(t+a,i+o-r.br),e.quadraticCurveTo(t+a,i+o,t+a-r.br,i+o),e.lineTo(t+r.bl,i+o),e.quadraticCurveTo(t,i+o,t,i+o-r.bl),e.lineTo(t,i+r.tl),e.quadraticCurveTo(t,i,t+r.tl,i),e.closePath(),n&&e.fill(),s&&e.stroke()},Drawing.drawEllipse=function(e,t,i,a,o,r,n){var s=t-a,h=i-o,c=2*a,l=2*o,d=.5522848,p=a*d,m=o*d,g=s+c,f=h+l;e.beginPath(),e.moveTo(s,i),e.bezierCurveTo(s,i-m,t-p,h,t,h),e.bezierCurveTo(t+p,h,g,i-m,g,i),e.bezierCurveTo(g,i+m,t+p,f,t,f),e.bezierCurveTo(t-p,f,s,i+m,s,i),r&&(e.fillStyle=r,e.fill()),n&&(e.strokeStyle=n),e.stroke()},Drawing.drawLines=function(e,t,i,a,o,r){e.beginPath(),r&&(e.strokeStyle=r);for(var n=a.split(" "),s=0,h=n.length;h>s;s++){var c=n[s++];switch(c){case"M":var l=parseInt(n[s++])+t,d=parseInt(n[s])+i;e.moveTo(l,d);break;case"L":var l=parseInt(n[s++])+t,d=parseInt(n[s])+i;e.lineTo(l,d)}}o&&(e.fillStyle=o,e.fill()),e.stroke()},document.addEventListener("dragstart",function(e){3===e.target.nodeType&&(e.preventDefault(),e.stopPropagation())},!1),MagicBoard.eventStart=function(e){var t=e.target.getAttribute("name");if(t){MagicBoard.indicators.mouseDown=!0;var i=MagicBoard.getPos(e);MagicBoard.indicators.click=i;var a=MagicBoard.indicators.mouseover.length;if(!MagicBoard.indicators.hilight&&a>0){a--;for(var o=MagicBoard.indicators.mouseover[a];o.parentShape;){var r=MagicBoard.indicators.mouseover[a--];if(!r)break;o=r}MagicBoard.indicators.lineActive=o;var n=MagicBoard.sheetBook.scratchCtx,s=MagicBoard.sheetBook.scratchCanvas;n.clearRect(0,0,s.width,s.height),n.beginPath(),n.strokeStyle="gray",n.lineWidth=1,n.setLineDash([5,5]),n.moveTo(i.x,i.y),MagicBoard.scratch.path=[i]}MagicBoard.indicators.doubleClick++,setTimeout(function(){MagicBoard.indicators.doubleClick--},400)}},MagicBoard.eventContinue=function(e){if(MagicBoard.indicators.mouseDown){var t=MagicBoard.indicators.click,i=null,a=MagicBoard.getPos(e);i=MagicBoard.indicators.hilight,i?MagicBoard.indicators.resize>-1?(i.resizeContinue(a,t),MagicBoard.indicators.resizeStarted=a):(MagicBoard.indicators.moveStarted=a,i.move(a,t)):(i=MagicBoard.indicators.lineActive,i&&(i.lineTo(a),MagicBoard.scratch.path.push(a)))}},MagicBoard.eventStop=function(e){if(MagicBoard.indicators.mouseDown){if(MagicBoard.indicators.mouseDown=!1,MagicBoard.indicators.moveStarted){var t,i,a=MagicBoard.indicators.hilight,o=MagicBoard.indicators.moveStarted,r=MagicBoard.indicators.click,n=a.getDimension(),s=o.x-r.x,h=o.y-r.y;if(MagicBoard.scratch.prevAlign){if(MagicBoard.scratch.prevAlign.left&&(i=MagicBoard.scratch.prevAlign.left),MagicBoard.scratch.prevAlign.top&&(t=MagicBoard.scratch.prevAlign.top),MagicBoard.scratch.prevAlign.right&&!MagicBoard.scratch.prevAlign.left){var c=MagicBoard.scratch.prevAlign.right-n.right;i=n.left+c}if(MagicBoard.scratch.prevAlign.bottom&&!MagicBoard.scratch.prevAlign.top){var c=MagicBoard.scratch.prevAlign.bottom-n.bottom;t=n.top+c}}i||(i=n.left+s),t||(t=n.top+h),a.setPosition({x:i,y:t,diffX:s,diffY:h}),MagicBoard.indicators.moveStarted=null,a.selectToggle()}else{var l=MagicBoard.indicators.mouseover.length;if(l>0){l--;for(var d=MagicBoard.indicators.mouseover[l];d.parentShape;){var p=MagicBoard.indicators.mouseover[l--];if(!p)break;d=p}var m=MagicBoard.indicators.lineActive;if(MagicBoard.indicators.resize>-1){var a=MagicBoard.indicators.hilight;a.resizeStop(),MagicBoard.scratch.path=[]}else m&&m!==d&&m!==d.parentShape?Utility.Sheet.connect(!1):Utility.Sheet.connect(!0)}else MagicBoard.indicators.lineActive?Utility.SheetBook.clearScratchCanvas():MagicBoard.indicators.resize>-1&&(a=MagicBoard.indicators.hilight,a.resizeStop())}if(MagicBoard.indicators.lineActive=null,MagicBoard.indicators.click=null,MagicBoard.indicators.doubleClick>1){var l=MagicBoard.indicators.mouseover.length;if(l>0)for(var g=0;l>g;g++){var a=MagicBoard.indicators.mouseover[g];a.doubleClick()}}}},MagicBoard.keyUp=function(e){var t=e.which;switch(e.ctrlKey?MagicBoard.indicators.keyType="ctrlKey":e.shiftKey&&(MagicBoard.indicators.keyType="shiftKey"),t){case 46:if(MagicBoard.indicators.hilight){var i=MagicBoard.indicators.hilight;i.click(),i.deleteShape()}break;case 67:case 99:"ctrlKey"===MagicBoard.indicators.keyType&&(MagicBoard.scratch.copy||(MagicBoard.scratch.copy=[]),MagicBoard.scratch.copy.push(MagicBoard.indicators.hilight));break;case 86:case 118:if("ctrlKey"===MagicBoard.indicators.keyType&&MagicBoard.scratch.copy)for(var a=MagicBoard.scratch.copy.length-1;a>-1;a--){var i=MagicBoard.scratch.copy[a],o=i.getShapeDetail(),r=new Shape(o);r.draw(),r.setPosition({x:i.dimension.right+20,y:i.dimension.top})}break;case 90:case 122:"ctrlKey"===MagicBoard.indicators.keyType&&MagicBoard.sheetBook.currentSheet.undo();break;default:return}},MagicBoard.getPos=function(e){var t,i,a=0,o=0;return e.pageX||e.pageY?(t=e.pageX-document.body.scrollLeft,i=e.pageY-document.body.scrollTop):(t=e.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,i=e.clientY+document.body.scrollTop+document.documentElement.scrollTop),t=(t-a-MagicBoard.boardPos.x)*MagicBoard.sheetBook.zoomCompensate,i=(i-o-MagicBoard.boardPos.y)*MagicBoard.sheetBook.zoomCompensate,{x:t,y:i}};var Utility={ShapeComponent:{},Shape:{},Sheet:{},SheetBook:{}};Utility.SheetBook.clearScratchCanvas=function(){var e=MagicBoard.sheetBook.scratchCtx,t=MagicBoard.sheetBook.scratchCanvas;e.clearRect(0,0,t.width,t.height)},Utility.SheetBook.createWorkItems=function(e){e.connectCanvas=document.createElement("canvas"),e.connectCanvas.setAttribute("style","position:absolute;left:0px;top:0px;z-index:1;"),this.connectCtx=null,e.connectCanvas.setAttribute("name","workItem"),e.connectCanvas.height=e.cheight,e.connectCanvas.width=e.cwidth,e.connectCtx=e.connectCanvas.getContext("2d"),e.connectCtx.translate(.5,.5),e.scratchCanvas=document.createElement("canvas"),e.scratchCanvas.setAttribute("style","position:absolute;left:0px;top:0px;z-index:1;"),e.scratchCtx=null,e.scratchCanvas.setAttribute("name","workItem"),e.scratchCanvas.height=e.cheight,e.scratchCanvas.width=e.cwidth,e.scratchCtx=e.scratchCanvas.getContext("2d"),e.scratchCtx.translate(.5,.5),e.hilighter=document.createElement("div"),e.hilighter.setAttribute("style","visibility:hidden;height:100px;width:100px;left:0px;top:0px;z-index:10"),e.hilighter.setAttribute("class","hilight"),e.hilighter.setAttribute("name","workItem"),e.hilighter.onmouseover=function(){MagicBoard.indicators.hilight&&MagicBoard.indicators.mouseover.push(MagicBoard.indicators.hilight)},e.hilighter.onmouseout=function(){event.preventDefault(),MagicBoard.indicators.mouseover=[]},e.hilighter.innerHTML="<div class='stretcher' name='workItem'><div class='red' name='workItem'></div></div><div class='stretcher name='workItem''><div class='red' name='workItem'></div></div><div class='stretcher' name='workItem'><div class='red' name='workItem'></div></div><div class='stretcher' name='workItem'><div class='red' name='workItem'></div></div><div class='stretcher' name='workItem'><div class='corner' name='workItem'></div></div><div class='stretcher' name='workItem'><div class='corner' name='workItem'></div></div><div class='stretcher' name='workItem'><div class='corner' name='workItem'></div></div><div class='stretcher' name='workItem'><div class='corner' name='workItem'></div></div>";var t=e.hilighter.children,i=function(){MagicBoard.indicators.mouseDown||(MagicBoard.indicators.resize=-1)};t[0].onmouseover=function(){MagicBoard.indicators.mouseDown||(MagicBoard.indicators.resize=0)},t[0].onmouseout=i,t[1].onmouseover=function(){MagicBoard.indicators.mouseDown||(MagicBoard.indicators.resize=1)},t[1].onmouseout=i,t[2].onmouseover=function(){MagicBoard.indicators.mouseDown||(MagicBoard.indicators.resize=2)},t[2].onmouseout=i,t[3].onmouseover=function(){MagicBoard.indicators.mouseDown||(MagicBoard.indicators.resize=3)},t[3].onmouseout=i,t[4].onmouseover=function(){MagicBoard.indicators.mouseDown||(MagicBoard.indicators.resize=4)},t[4].onmouseout=i,t[5].onmouseover=function(){MagicBoard.indicators.mouseDown||(MagicBoard.indicators.resize=5)},t[5].onmouseout=i,t[6].onmouseover=function(){MagicBoard.indicators.mouseDown||(MagicBoard.indicators.resize=6)},t[6].onmouseout=i,t[7].onmouseover=function(){MagicBoard.indicators.mouseDown||(MagicBoard.indicators.resize=7)},t[7].onmouseout=i,e.textEditor=document.createElement("div"),e.textEditor.setAttribute("contenteditable","true"),e.textEditor.setAttribute("style","position:absolute;left:0px;top:0px;width:10px;height:14px;display:none;background:white;z-index:100"),document.body.appendChild(e.textEditor),e.textEditor.onblur=function(){e.textEditor.style.display="none";var t=e.textEditor.targetShape;t.updateText(e.textEditor.innerHTML),t.selectToggle(),e.textEditor.targetShape=null},e.star=document.createElementNS("http://www.w3.org/2000/svg","svg"),e.star.setAttribute("style","display:none;position:absolute;left:0px;top:0px;z-index:10;width:50px;height:21px"),e.star.innerHTML='<polygon points="10,1 4,20 19,8 1,8 16,20" style="fill:red;stroke:red;stroke-width:1;fill-rule:nonzero;" />',e.star.onclick=function(){var t=e.star.cLine;t&&t.click()},Utility.SheetBook.attachWorkItems(e);var a=document.createElementNS("http://www.w3.org/2000/svg","svg");e.sampleText=document.createElementNS("http://www.w3.org/2000/svg","text"),e.sampleText.setAttribute("style","visibility:hidden"),a.appendChild(e.sampleText),document.body.appendChild(a)},Utility.SheetBook.attachWorkItems=function(e){sheetCanvas=e.anchor,sheetCanvas.appendChild(e.scratchCanvas),sheetCanvas.appendChild(e.connectCanvas),sheetCanvas.appendChild(e.hilighter),sheetCanvas.appendChild(e.star)},Utility.SheetBook.activateHilighter=function(e,t){var i=MagicBoard.sheetBook.hilighter;i.style.visibility="visible",Utility.SheetBook.resizeHilighter(e,t)},Utility.SheetBook.resizeHilighter=function(e,t){var i=MagicBoard.sheetBook.hilighter,a=e.left-4,o=e.top-4,r=e.width+8,n=e.height+8;i.style.left=a+"px",i.style.top=o+"px",i.style.width=r+"px",i.style.height=n+"px";var s=i.children,h=s[0].style;h.left="-12px",h.top=n/2-12+"px",h.cursor="ew-resize";var c=s[1].style;c.left=r-14+"px",c.top=n/2-12+"px",c.cursor="ew-resize";var l=s[2].style;l.left=r/2-12+"px",l.top="-12px",l.cursor="ns-resize";var d=s[3].style;d.left=r/2-12+"px",d.top=n-14+"px",d.cursor="ns-resize";var p=s[4].style;p.left="-12px",p.top="-12px",p.cursor="nw-resize";var m=s[5].style;m.left="-12px",m.top=n-14+"px",m.cursor="sw-resize";var g=s[6].style;g.left=r-12+"px",g.top="-12px",g.cursor="ne-resize";var f=s[7].style;f.left=r-12+"px",f.top=n-14+"px",f.cursor="nw-resize"},Utility.SheetBook.createSheet=function(e,t){var i={name:e,shapes:[]},a=MagicBoard.sheetBook.garbage;a.innerHTML=t;var o=a.children,r=[],n=Aux.createShapeJson1(o[0],i.shapes,r,0);i.shapes.push(n);var s=new Sheet(i);return MagicBoard.sheetBook.addSheet(s),MagicBoard.sheetBook.setCurrentSheet(s),a.innerHTML="",s},Utility.Sheet.Markers=function(e){var t="<defs></defs>";e.canvas.innerHTML=t},Utility.Sheet.createGrid=function(e){e.courseGridSize={x:100,y:100},e.noOfXcourseGrids=Math.floor(MagicBoard.sheetBook.cwidth/e.courseGridSize.x),e.noOfYcourseGrids=Math.floor(MagicBoard.sheetBook.cheight/e.courseGridSize.y),e.courseGrids=[];for(var t=0,i=0;i<e.noOfYcourseGrids;i++)for(var a=i*e.courseGridSize.y,o=(i+1)*e.courseGridSize.y,r=0;r<e.noOfXcourseGrids;r++){var n=r*e.courseGridSize.x,s=(r+1)*e.courseGridSize.x,h={filled:!1,shapes:[],x1:n,x2:s,y1:a,y2:o,index:t++};e.courseGrids.push(h)}},Utility.Sheet.isGridAvailable=function(e,t,i){var a=i.dimension,o=t.courseGrids,r=o.length,n=t.noOfXcourseGrids,s=(t.noOfYcourseGrids,10),h=MagicBoard.sheetBook.cwidth,c=MagicBoard.sheetBook.cheight;if(-1===e){var l=0,d=0;a.left&&(l=a.left),e=Utility.Sheet.LeftAlignedFreeGrid(l,d,t);for(var p=e;r>p;p++){var m=o[p];if(!m.filled)return Utility.Sheet.isGridAvailable(p,t,i)}}var g=o[e],f=g.x1+s,u=g.y1+s,v={x:f,y:u},y={x:f+a.width,y:u};if(y.x>h)return Utility.Sheet.isGridAvailable(e+1,t,i);var x={x:f,y:u+a.height};if(x.y>c)return[];for(var B=({x:f+a.width,y:u+a.height},Math.floor(e/n)+1,[]),S=e;r>S;S++){var M,b,k,w,m=o[S];if(M=m.x1,b=m.x2,k=m.y1,w=m.y2,!(b<v.x||M>y.x)){if(k>x.y)break;if(!(w<v.y)){if(m.filled){for(var C=S;r>C;C++){if(C>=r)return[];if(!o[C].filled)break}var T=Utility.Sheet.isGridAvailable(C,t,i);if(T.length>0)return T}B.push(S)}}}return B},Utility.Sheet.LeftAlignedFreeGrid=function(e,t,i){var a=i.noOfXcourseGrids,o=i.courseGrids;return startGridSeq=Math.floor(t/i.courseGridSize.y)*a+Math.floor(e/i.courseGridSize.x),startGridSeq>o.length?0:o[startGridSeq].filled?e?Utility.Sheet.LeftAlignedFreeGrid(e,t+i.courseGridSize.y,i):startGridSeq++:startGridSeq},Utility.Sheet.findOwner=function(e){for(var t=MagicBoard.sheetBook.currentSheet,i=t.shapes.length,a=0;i>a;a++){var o=t.shapes[a];if(o.dom===e)return o.dom;for(var r=o.components.length,n=0;r>n;n++){var s=o.components[n];if(s.dom===e)return s}}return null},Utility.Sheet.connect=function(e){var t=MagicBoard.sheetBook.currentSheet,i=MagicBoard.scratch.path,a=null,o=null;if(e&&i.length<6){if(a=MagicBoard.indicators.lineActive,!a&&(a=MagicBoard.indicators.mouseover[0])){var r=MagicBoard.indicators.hilight;r&&r.selectToggle()}return void a.click()}for(var n=i[0],s=t.findShapeByPosition(n),h=0,c=s.length;c>h;h++){var l=s[h];if(!l.param.connectRules.noConnection){a=l;break}}for(var d=i[i.length-1],p=t.findShapeByPosition(d),m=0,g=p.length;g>m;m++){var l=p[m];if(!l.param.connectRules.noConnection){o=l;break}}a&&o&&(i.length>5?a.connectTo(o):o.click())},Utility.Sheet.connectIds=function(){for(var e=MagicBoard.sheetBook.currentSheet,t=e.shapes.length,i=0;t>i;i++){var a=e.shapes[i];if(a.connectedFromIds)for(var o=0,r=a.connectedFromIds.length;r>o;o++){var n=a.connectedFromIds[o];a.connectedFrom.push(Utility.Sheet.findShapeById(n))}if(a.connectedToIds)for(var o=0,r=a.connectedToIds.length;r>o;o++){var s=a.connectedToIds[o];a.connectedTo.push(Utility.Sheet.findShapeById(s))}}for(var i=0;t>i;i++){var a=e.shapes[i];a.refreshConnection()}},Utility.Sheet.findShapeById=function(e){for(var t=MagicBoard.sheetBook.currentSheet,i=t.shapes.length,a=0;i>a;a++){var o=t.shapes[a];if(o.id===e)return o}},Utility.Shape.definePeriferalPoints=function(e,t){e.right=e.left+e.width,e.bottom=e.top+e.height,e.cx=e.left+e.width/2,e.cy=e.top+e.height/2;var i={c1:{x:e.left,y:e.top},c2:{x:e.right,y:e.top},c3:{x:e.right,y:e.bottom},c4:{x:e.left,y:e.bottom},m12:{x:e.cx,y:e.top},m23:{x:e.right,y:e.cy},m34:{x:e.cx,y:e.bottom},m41:{x:e.left,y:e.cy}};if(e.edgePoints){var a=e.edgePoints;a.c1=i.c1,a.c2=i.c2,a.c3=i.c3,a.c4=i.c4,a.m12=i.m12,a.m23=i.m23,a.m34=i.m34,a.m41=i.m41}else e.edgePoints=i;t&&(e.offsetX=e.left-t.left,e.offsetY=e.top-t.top)},Utility.Shape.adjustComponents=function(e,t){var i=e.originalFrame,a=e.frame,o=!1;e.parentShape&&(o=!0);for(var r in t){var n=a[r];o&&(n=Utility.Shape.dataFormatter(i[r],r,e)),a[r]=n+t[r],e.dom.setAttribute(r,a[r])}e.drawn=!1;for(var s=0,h=e.children.length;h>s;s++){var c=e.children[s];c.drawn=!1;for(var r in c.originalFrame)if("height"===r||"width"===r){var n=Utility.Shape.dataFormatter(c.originalFrame[r],r,c);if(n===c.frame[r])continue;c.frame[r]=n,c.dom.setAttribute(r,n)}}e.setPosition({x:a.left,y:a.top})},Utility.Shape.resize=function(e,t,i){e.dimension.resizeX||(e.dimension.resizeX=e.dimension.left),e.dimension.resizeY||(e.dimension.resizeY=e.dimension.top);var a=e.dimension.resizeX,o=e.dimension.resizeY,r=!1,n=MagicBoard.indicators.resize;if(2>n){e.dimension.resizeWidth||(e.dimension.resizeWidth=e.dimension.width);var s=e.dimension.resizeWidth,h=s;0===MagicBoard.indicators.resize?(a+=t,h=s-t,r=!0):h=s+t,e.dimension.width=h,e.dom.setAttribute("width",h)}else if(4>n){e.dimension.resizeHeight||(e.dimension.resizeHeight=e.dimension.height);var c=e.dimension.resizeHeight,l=c;2===MagicBoard.indicators.resize?(o+=i,l=c-i,r=!0):l=c+i,e.dimension.height=l,e.dom.setAttribute("height",l)}else{e.dimension.resizeWidth||(e.dimension.resizeWidth=e.dimension.width);var s=e.dimension.resizeWidth,h=s;e.dimension.resizeHeight||(e.dimension.resizeHeight=e.dimension.height);var c=e.dimension.resizeHeight,l=c;4===n?(a+=t,h=s-t,o+=i,l=c-i,r=!0):5===n?(a+=t,h=s-t,l=c+i,r=!0):6===n?(h=s+t,o+=i,l=c-i,r=!0):7===n&&(h=s+t,l=c+i),e.dimension.width=h,e.dom.setAttribute("width",h),e.dimension.height=l,e.dom.setAttribute("height",l)}r&&e.setPosition({x:a,y:o}),e.reDraw()},Utility.Shape.applyProperty=function(){var e=document.getElementById("propPrompt"),t=e.shape;e.shape=null;for(var i=e.getElementsByClassName("prop"),a=i.length,o=0;a>o;o++){var r=i[o],n=r.getAttribute("data-dirty");if(n&&"1"===n){var s,h=r.getAttribute("data-propKey"),c=r.getAttribute("data-propType"),l=r.getAttribute("data-propName");"INPUT"===r.nodeName?s=r.value:"SELECT"===r.nodeName&&(s=r.options[r.selectedIndex].value),t.applyProperty(h,l,c,s)}}Utility.destroyDom(e,"dom")},Utility.addChangeFlag=function(){var e=event.target;e.setAttribute("data-dirty","1")},Utility.Shape.showProperty=function(){var e="",t=MagicBoard.indicators.hilight,i=t.properties;i.length;for(var a in i){var o=MagicBoard.properties[a];if("input"===o.field)e+="<label class='propLabel'>"+o.label+":</label><input class='propInput prop' data-propKey='"+a+"' class='prop' data-propType='"+o.propType+"'  data-propName='"+o.propName+"' type='"+o.values[0].type+"' value='"+o.values[0].value+"' onchange='Utility.addChangeFlag()'/><BR/>";else if("select"===o.field){e+="<label class='propLabel' >"+o.label+":</label><select onchange='Utility.addChangeFlag()' data-propKey='"+a+"' class='prop' data-propType='"+o.propType+"'  data-propName='"+o.propName+"'  >";for(var r=0,n=o.values.length;n>r;r++)e+="<option value='"+o.values[r].value+"' >"+o.values[r].name+"</option>";e+="</select><BR/>"}}if(e){e+="<br/><button class='apply button' onclick='Utility.Shape.applyProperty()'>Apply</button><button class='cancel button' onclick='Utility.destroyDom(\"propPrompt\",\"id\")'>Cancel</button>";var s=document.createElement("div");s.setAttribute("class","prompt"),s.setAttribute("style",""),s.setAttribute("id","propPrompt"),s.innerHTML=e,s.shape=t,document.body.appendChild(s)}},Utility.Shape.placement=function(e){var t=!1,i=e.frame,a=null,o=JSON.parse(JSON.stringify(i));e.parentShape&&(a=e.parentShape.frame);var r=e.param.placementRules;if(r)for(var n=0,s=r.length;s>n;n++){var h,c=r[n];if("parent"===c.ref){if(!e.parentShape)break;h=a[c.refDimension]}else if("sibling"===c.ref)for(var l=e.parentShape.children,d=0,p=l.length;p>d;d++){var m=l[d];if(m===e)break;h=m.frame[c.refDimension]}switch(c.cond){case"=":switch(o[c.dimension]=e.dimension[c.dimension],e.dimension[c.dimension]=h,c.dimension){case"cx":i.left=i.cx-i.width/2,i.right=i.left+i.width;break;case"cy":i.top=i.cy-i.height/2,i.bottom=i.top+i.height;break;case"left":i.right=i.left+i.width;break;case"top":i.bottom=i.top+i.height}t=!0;break;case"<":if(e.dimension[c.dimension]>h){switch(o[c.dimension]=e.dimension[c.dimension],e.dimension[c.dimension]=h,c.dimension){case"cx":i.left=i.cx-i.width/2,i.right=i.left+i.width;break;case"cy":i.top=i.cy-i.height/2,i.bottom=i.top+i.height;break;case"left":i.right=i.left+i.width;break;case"top":i.bottom=i.top+i.height}t=!0}break;case">":if(e.dimension[c.dimension]<h){switch(o[c.dimension]=e.dimension[c.dimension],e.dimension[c.dimension]=h,c.dimension){case"cx":i.left=i.cx-i.width/2,i.right=i.left+i.width;break;case"cy":i.top=i.cy-i.height/2,i.bottom=i.top+i.height;break;case"left":i.right=i.left+i.width;break;case"top":i.bottom=i.top+i.height}t=!0}}}if(t){i.right&&(i.width=i.right-i.left),i.bottom&&(i.height=i.bottom-i.top),Utility.Shape.definePeriferalPoints(i,a);for(var g in o)if(o[g]!==i[g])switch(g){case"cx":case"left":e.dom.setAttribute("x",i.left);break;case"cy":case"top":e.dom.setAttribute("y",i.top);break;case"right":case"width":e.dom.setAttribute("width",i.width);break;case"bottom":case"hight":e.dom.setAttribute("height",i.height)}}},Utility.Shape.align=function(e){var t=MagicBoard.sheetBook.alignments.x,i=MagicBoard.sheetBook.alignments.y,a=9999,o=9999,r=e.x;nearestY=e.y;for(var n in t)if(t[n]&&t[n].length>0){var s=Math.abs(e.y-n);o>s&&(o=s,
nearestY=n)}for(var h in i)if(i[h]&&i[h].length>0){var s=Math.abs(e.x-h);a>s&&(a=s,r=h)}return Math.abs(e.x-r)<20&&("string"==typeof r&&(r=parseInt(r)),e.x=r),Math.abs(e.y-nearestY)<20&&("string"==typeof nearestY&&(nearestY=parseInt(nearestY)),e.y=nearestY),e},Utility.Shape.connectTo=function(e,t,i){for(var a=e.events,o=e.connectedTo,r=!1,n=o.length,s=0;n>s;s++){var h=o[s];if(t===h){r=!0;break}}r||(e.connectedTo.push(t),t.connectFrom(e));var c;if(r){var l=MagicBoard.sheetBook.star.cLine;c=l.cInfo,c.connProp=i}else c=Utility.Shape.calculateConnectionPoints(e,t,i);if(c){a&&a.connectTo&&a.connectTo.click&&(c.events||(c.events={}),c.events.click=a.connectTo.click);var d=MagicBoard.sheetBook.currentSheet;d.addConnections(c),d.drawConnections(),MagicBoard.changed=!0}},Utility.Sheet.drawCourseGrid=function(e){var t=MagicBoard.sheetBook.scratchCtx,i=MagicBoard.sheetBook.scratchCanvas;t.clearRect(0,0,i.width,i.height),t.setLineDash([1,15]),t.beginPath();for(var a=0,o=0;o<e.noOfYcourseGrids;o++){var r=o*e.courseGridSize.y;t.moveTo(0,r),t.lineTo(MagicBoard.sheetBook.cwidth,r);for(var n=0;n<e.noOfXcourseGrids;n++){var s=n*e.courseGridSize.x;t.moveTo(s,0),t.lineTo(s,MagicBoard.sheetBook.cheight);var h="Filled "+a,c=e.courseGrids[a++];c.filled&&t.fillText(h,s+20,r+20)}}t.stroke()},Utility.Shape.blockGrids=function(e){var t=e.currentSheet,i=e.dimension,a=t.courseGrids;Utility.Shape.unblockGrids(e,a);for(var o=i.left,r=i.top,n=Math.floor(o/t.courseGridSize.x),s=Math.floor(r/t.courseGridSize.y),h=s*t.noOfXcourseGrids+n,c={x:o,y:r},l={x:o+i.width,y:r},d={x:o,y:r+i.height},a=({x:o+i.width,y:r+i.height},t.courseGrids),p=a.length,m=h;p>m;m++){var g,f,u,v,y=a[m];if(g=y.x1,f=y.x2,u=y.y1,v=y.y2,!(f<c.x||g>l.x)){if(u>d.y)break;v<c.y||(y.filled=!0,y.shapes.push(e),e.occupiedGrids.push(m))}}},Utility.Shape.unblockGrids=function(e,t){for(var i=e.occupiedGrids,a=i.length,o=0;a>o;o++){for(var r=i[o],n=t[r],s=n.shapes,h=s.length,c=0;h>c;c++){var l=s[c];if(l===e){s.splice(c,1);break}}0===s.length&&(n.filled=!1)}e.occupiedGrids=[]},Utility.Shape.reCalculateConnectionPoints=function(e){var t=e.beginShape,i=e.endShape,a=e.pos,o=a.pointStart.label,r=a.pointEnd.label,n=t.frame.edgePoints,s=i.frame.edgePoints;a.x1=n[o].x,a.y1=n[o].y,a.x2=s[r].x,a.y2=s[r].y;for(var h=e.turningPoints,c={x:a.x1,y:a.y1,angle:a.startAngle},l=0,d=h.length;d>l;l++){var p=h[l],m=c.angle;0===m?p.y=c.y:p.x=c.x,c=p}for(var p={x:a.x2,y:a.y2},l=h.length-1;l>-1;l--){var c=h[l],m=c.angle;0===m?c.y=p.y:c.x=p.x,p=c}},Utility.Shape.calculateConnectionPoints=function(e,t,i){var a,o,r,n,s=e.getDimension(),h=t.getDimension(),c=s.edgePoints,l=h.edgePoints,d=[];if(MagicBoard.scratch.path.length>3){for(var p=Utility.identifyLines(MagicBoard.scratch.path),d=[],m=0,g=p.length;g>m;m++){var f=p[m].point;f.angle=p[m].angle,d.push(f)}var u=function(e,t){var i=t+"c";return e.edgePoints[i]?u(e,i):i};d.push(MagicBoard.scratch.path[MagicBoard.scratch.path.length-1]),b=d.length;var v,y,x={};v=d[b-1],y=d[b-2];var B=Math.abs(180*Math.atan((v.y-y.y)/(v.x-y.x))/Math.PI);if(B=45*Math.round(B/45),0===B)if(y.x>v.x)if(x.pointEnd={label:"m23",x:x.x2,y:x.y2},x.x2=l.m23.x,t.param.connectRules.connectInPlace){x.y2=v.y;var S=u(h,x.pointEnd.label);x.pointEnd.label=S,h.edgePoints[S]={x:x.x2,y:x.y2}}else x.y2=l.m23.y;else if(x.pointEnd={label:"m41",x:x.x2,y:x.y2},x.x2=l.m41.x,t.param.connectRules.connectInPlace){x.y2=v.y;var S=u(h,x.pointEnd.label);x.pointEnd.label=S,h.edgePoints[S]={x:x.x2,y:x.y2}}else x.y2=l.m41.y;else if(y.y>v.y){if(x.pointEnd={label:"m34",x:x.x2,y:x.y2},t.param.connectRules.connectInPlace){x.x2=v.x;var S=u(h,x.pointEnd.label);x.pointEnd.label=S,h.edgePoints[S]={x:x.x2,y:x.y2}}else x.x2=l.m34.x;x.y2=l.m34.y}else{if(x.pointEnd={label:"m12",x:x.x2,y:x.y2},t.param.connectRules.connectInPlace){x.x2=v.y;var S=u(h,x.pointEnd.label);x.pointEnd.label=S,h.edgePoints[S]={x:x.x2,y:x.y2}}else x.x2=l.m12.x;x.y2=l.m12.y}if(v=d[0],y=d[1],B=Math.abs(180*Math.atan((v.y-y.y)/(v.x-y.x))/Math.PI),B=45*Math.round(B/45),0===B)if(y.x>v.x){if(x.pointStart={label:"m23"},x.x1=c.m23.x,e.param.connectRules.connectInPlace){x.y1=v.y;var S=u(s,x.pointStart.label);x.pointStart.label=S,s.edgePoints[S]={x:x.x1,y:x.y1}}else x.y1=c.m23.y;x.pointStart.x=x.x1,x.pointStart.y=x.y1}else{if(x.pointStart={label:"m41"},x.x1=c.m41.x,e.param.connectRules.connectInPlace){x.y1=v.y;var S=u(s,x.pointStart.label);x.pointStart.label=S,s.edgePoints[S]={x:x.x1,y:x.y1}}else x.y1=c.m41.y;x.pointStart.x=x.x1,x.pointStart.y=x.y1}else if(y.y>v.y){if(x.pointStart={label:"m34"},x.y1=c.m34.y,e.param.connectRules.connectInPlace){x.x1=v.x;var S=u(s,x.pointStart.label);x.pointStart.label=S,s.edgePoints[S]={x:x.x1,y:x.y1}}else x.x1=c.m34.x;x.pointStart.x=x.x1,x.pointStart.y=x.y1}else{if(x.pointStart={label:"m12"},x.y1=c.m12.y,e.param.connectRules.connectInPlace){x.x1=v.x;var S=u(s,x.pointStart.label);x.pointStart.label=S,s.edgePoints[S]={x:x.x1,y:x.y1}}else x.x1=c.m12.x;x.pointStart.x=x.x1,x.pointStart.y=x.y1}if(b=d.length,b>2){var v={x:x.x1,y:x.y1,angle:d[0].angle};d.splice(b-1,1),d.splice(0,1);for(var M=0,b=d.length;b>M;M++){var y=d[M],B=v.angle;0===B?y.y=v.y:y.x=v.x,v=y}for(var y={x:x.x2,y:x.y2},M=d.length-1;M>-1;M--){var v=d[M],B=v.angle;0===B?v.y=y.y:v.x=y.x,y=v}}else{if(2===b&&e.param.connectRules.connectInPlace){var B=x.angle;90===B?x.x2=x.x1:x.y2=x.y1,h.edgePoints[x.pointEnd.label]={x:x.x2,y:x.y2}}d=[]}return{beginShape:e,endShape:t,pos:x,turningPoints:d,connProp:i}}var k="horiz";if(c.c1.x>l.c2.x){var w=c.m41.x-l.m23.x;if(w>50)a=c.m41.x,r=c.m41.y,o=l.m23.x,n=l.m23.y;else{var C=c.m41.y-l.m23.y,T=(c.m12.x-l.m23.x,c.m12.y-l.m23.y),A=(c.m12.x-l.m23.x,c.m12.y-l.m23.y);if(T>50)c.m12.x-l.m34.x>50?(a=c.m12.x,r=c.m12.y,o=l.m34.x,n=l.m34.y,k="vert"):(a=c.m12.x,r=c.m12.y,o=l.m23.x,n=l.m23.y,k="horizvert");else if(A>50)a=c.m34.x,r=c.m34.y,o=l.m23.x,n=l.m23.y,k="horizvert";else if(C>50){var I=c.m41.y-l.m34.y;I>50?(a=c.m41.x,r=c.m41.y,o=l.m34.x,n=l.m34.y):(a=c.m41.x,r=c.m41.y,o=l.m23.x,n=l.m23.y)}else a=c.m41.x,r=c.m41.y,o=l.m23.x,n=l.m23.y}}else if(c.c2.x<l.c1.x){var P=c.m41.x-l.m23.x;if(P>50)a=c.m23.x,r=c.m23.y,o=l.m41.x,n=l.m41.y;else{var D=(c.m23.y-l.m41.y,c.m23.x-l.m12.x,c.m23.y-l.m12.y),L=(c.m23.x-l.m34.x,c.m23.y-l.m34.y);Math.abs(L)>50?(a=c.m23.x,r=c.m23.y,L>0?(o=l.m34.x,n=l.m34.y):(o=l.m12.x,n=l.m12.y),k="horizvert"):D>50?l.m41.x-c.m23.x>50?(a=c.m23.x,r=c.m23.y,o=l.m41.x,n=l.m41.y):(a=c.m23.x,r=c.m23.y,o=l.m12.x,n=l.m12.y,k="horizvert"):(a=c.m23.x,r=c.m23.y,o=l.m41.x,n=l.m41.y)}}else c.c1.y>l.c3.y?(a=c.m12.x,r=c.m12.y,o=l.m34.x,n=l.m34.y,k="vert"):(a=c.m34.x,r=c.m34.y,o=l.m12.x,n=l.m12.y,k="vert");return{beginShape:e,endShape:t,pos:{x1:a,x2:o,y1:r,y2:n},orientation:k,connProp:i}},Utility.Shape.defineConnectionCoordinates=function(e,t){var i,a,o,r,n,s,h,c,l=t.pos,h=l.x1,c=l.y1,d=h,p=c,m=l.x2,g=l.y2;h>m&&(d=m),c>g&&(p=g),d-=10,p-=10;var f=Math.abs(l.x2-l.x1)+20,u=Math.abs(l.y2-l.y1)+20;e.frame={width:f,height:u,unit:"px",left:d,top:p};var v=((l.x1+l.x2)/2,(l.y1+l.y2)/2,[]),y=[];v.push({op:"M",x:l.x1,y:l.y1}),y.push({op:"M",x:100*(l.x1-d)/f,y:100*(l.y1-p)/u});t.connProp;if(t.turningPoints&&t.turningPoints.length>0){for(var x=l.x1,B=l.y1,S=l.x1,M=l.y1,b=t.turningPoints,k=b.length,w=0;k>w;w++){var C=b[w];C.x<x&&(x=C.x),C.y<B&&(B=C.y),C.x>S&&(S=C.x),C.y>M&&(M=C.y)}l.x2<x&&(x=l.x2),l.y2<B&&(B=l.y2),l.x2>S&&(S=l.x2),l.y2>M&&(M=l.y2),e.frame.width<S-x+20&&(e.frame.width=S-x+20,f=e.frame.width),e.frame.height<M-B+20&&(e.frame.height=M-B+20,u=e.frame.height),d>x&&(d=x-10,e.frame.left=d),p>B&&(p=B-10,e.frame.top=p),y[0]={op:"M",x:100*(l.x1-d)/f,y:100*(l.y1-p)/u};for(var w=0;k>w;w++){var C=b[w];v.push({op:"L",x:C.x,y:C.y}),y.push({op:"L",x:100*(C.x-d)/f,y:100*(C.y-p)/u})}i=Drawing.getLineAngle(l.x1,l.y1,b[0].x,b[0].y),a=Drawing.getLineAngle(l.x2,l.y2,b[k-1].x,b[k-1].y)}else i=Drawing.getLineAngle(l.x1,l.y1,l.x2,l.y2),a=Drawing.getLineAngle(l.x2,l.y2,l.x1,l.y1);e.cInfo.angleStart=i,e.cInfo.angleEnd=a,e.cx1=o,e.cx2=r,e.cy1=n,e.cy2=s;var T=e.frame;return T.right=T.left+T.width,T.bottom=T.top+T.height,v.push({op:"L",x:m,y:g}),y.push({op:"L",x:100*(m-d)/f,y:100*(g-p)/u}),{d:y,lines:v}},Utility.Sheet.removeConnection=function(e,t,i){for(var a=e.connections,o=a.length,r=0;o>r;r++){var n=a[r];if(n.beginShape===t&&n.endShape===i)return a.splice(r,1),void n.shape.deleteShape()}},Utility.identifyLines=function(e){var t=e.length;if(3>t)return[];for(var i=[],a={point:null,length:0,angle:null},o=e[0],r={id:0,point:o,length:0,angle:null,active:!1},n=1;t>n;n++){var s=e[n],h=Math.abs(180*Math.atan((s.y-o.y)/(s.x-o.x))/Math.PI);if(NaN!=h){if(s.angle=h,h=45*Math.round(h/45),s.curedAngle=h,r.active){var c=Math.abs(Math.abs(h)-Math.abs(r.angle));if(c>45){a.count||(a.point=s,a.angle=h,a.active=!0,a.count=0),a.count++;var l=s.x-a.point.x,d=s.y-a.point.y;a.length=Math.sqrt(l*l+d*d),a.count>6&&(i.push(r),a.id=r.id+1,r=a,r.angle=h,a={point:null,length:0,angle:null,active:!1})}else{a.active&&(a={point:null,length:0,angle:null,active:!1,count:0});var l=s.x-r.point.x,d=s.y-r.point.y;r.length=Math.sqrt(l*l+d*d)}}else r.angle=h,r.active=!0;o=s}}if(0===i.length||r.id!==i[i.length-1])if(0===i.length)i.push(r);else{var p=i[i.length-1],l=r.point.x-p.point.x,d=r.point.y-p.point.y,m=Math.sqrt(l*l+d*d);m>10&&i.push(r)}return i},Utility.Shape.dataFormatter=function(e,t,i){if(void 0==e)return 0;if("number"==typeof e)return e;if("string"==typeof e){if(e.indexOf("px")>-1)return parseInt(e.replace("px",""));if(e.indexOf("%")>-1){if(!i)return console.log(" In order to calculate %, we need the shape, that is missing in the call"),0;var a=parseInt(e.replace("%","")),o=!0,r=null;if(i.parentShape)r=i.parentShape.dimension;else{var n=MagicBoard.sheetBook;r={left:0,top:0,width:n.cwidth,height:n.cheight},o=!1}var s=t;return"left"===t?s="width":"top"===t&&(s="height"),a=r[s]*a/100,isNaN(a)?0:(o&&("left"===t?a=r.left+a:"top"===t&&(a=r.top+a)),isNaN(a)?0:a)}}},Utility.Shape.recalculateDimensions=function(e){var t=e.dimension;if(t.misc.unit&&"%"===t.misc.unit)for(var i=t.misc.key,a=i.length,o=0;a>o;o++){var r=i[o],n=e.style[r],s=Utility.Shape.dataFormatter(n,r,e);t[r]=s}},Utility.ShapeComponent.createTextNode=function(e){var t=e.innerHTML,i=0,a=0,o=e.parentShape,r=o.frame,n=e.param["font-size"];n||(n=12),maxHeight=3;var s=[];if(r.maxRight){var h=t.split(" "),c=h[0],l="";a=r.maxRight-r.left;for(var d=1,p=h.length;p>d;d++)c+=" "+h[d],MagicBoard.sheetBook.sampleText.innerHTML="",MagicBoard.sheetBook.sampleText.appendChild(document.createTextNode(c)),i=MagicBoard.sheetBook.sampleText.getComputedTextLength(),i>a&&(maxHeight+=n,s.push(l),c=h[d]),l=c;1===p&&(l=c),l&&(s.push(l),maxHeight+=n)}else{s=t.split("\n");for(var m=0,g=s.length;g>m;m++){var c=s[m];maxHeight+=n,MagicBoard.sheetBook.sampleText.innerHTML="",MagicBoard.sheetBook.sampleText.appendChild(document.createTextNode(c)),i=MagicBoard.sheetBook.sampleText.getComputedTextLength(),i>a&&(a=i)}}a>r.width&&(r.width=a,o.dom.setAttribute("width",a+5),e.innerHTML="",e.construct(),e.innerHTML=t,MagicBoard.indicators.hilight&&o.selectToggle()),maxHeight>r.height&&(r.height=maxHeight,o.dom.setAttribute("height",maxHeight+5),e.innerHTML="",e.construct(),e.innerHTML=t,MagicBoard.indicators.hilight&&o.selectToggle(),Utility.Shape.placement(o));for(var f="",u="dy =''",v=e.derivedDimension.x,y=0,x=s.length;x>y;y++){var B=s[y];B&&(f+="<tspan name='mg' x='"+v+"' "+u+">"+Utility.htmlEncode(B)+"</tspan>"),u=" dy = '"+n+"px' "}e.dom.innerHTML=f},Utility.isIntersecting=function(e,t,i,a){var o=function(e,t,i){return(i.y-e.y)*(t.x-e.x)>(t.y-e.y)*(i.x-e.x)};return o(e,i,a)!=o(t,i,a)&&o(e,t,i)!=o(e,t,a)},Utility.destroyDom=function(e,t){var i=MagicBoard.sheetBook.garbage,a=null;"id"===t?a=document.getElementById(e):"dom"===t&&(a=e),i.appendChild(a),i.innerHTML=""},Utility.htmlEncode=function(e){for(var t="",i=e.length,a=0;i>a;a++){var o=e.charAt(a);switch(o){case"&":t+="&amp;";break;case">":t+="&gt;";break;case"<":t+="&lt;";break;default:t+=o}}return t};var Logger=function(){},Info=function(){};inheritsFrom(Info,Logger),Info.prototype.console=function(e){console.log("Info - "+e)};var Warning=function(){};inheritsFrom(Warning,Logger),Warning.prototype.console=function(e){console.log("Warning - "+e)};var Error=function(){};inheritsFrom(Error,Logger),Error.prototype.console=function(e){Error.log("Error - "+e)};var info=new Info,warning=new Warning,error=new Error;